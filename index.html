<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minimum Messenger</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- Tailwind Config for Material 3 Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    },
                    colors: {
                        md: {
                            sys: {
                                color: {
                                    primary: 'var(--md-sys-color-primary)',
                                    onPrimary: 'var(--md-sys-color-on-primary)',
                                    primaryContainer: 'var(--md-sys-color-primary-container)',
                                    onPrimaryContainer: 'var(--md-sys-color-on-primary-container)',
                                    secondary: 'var(--md-sys-color-secondary)',
                                    surface: 'var(--md-sys-color-surface)',
                                    surfaceVariant: 'var(--md-sys-color-surface-variant)',
                                    onSurface: 'var(--md-sys-color-on-surface)',
                                    onSurfaceVariant: 'var(--md-sys-color-on-surface-variant)',
                                    outline: 'var(--md-sys-color-outline)',
                                    background: 'var(--md-sys-color-background)',
                                }
                            }
                        }
                    },
                    borderRadius: {
                        '4xl': '2rem',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --md-sys-color-primary: #a8c7fa;
            --md-sys-color-on-primary: #0f305f;
            --md-sys-color-primary-container: #2b4778;
            --md-sys-color-on-primary-container: #d7e3ff;
            --md-sys-color-secondary: #bec6dc;
            --md-sys-color-surface: #111318;
            --md-sys-color-surface-variant: #44474f;
            --md-sys-color-on-surface: #e2e2e6;
            --md-sys-color-on-surface-variant: #c4c6d0;
            --md-sys-color-outline: #8e9099;
            --md-sys-color-background: #111318;
            
            --bubble-radius: 1.5rem;
            --font-scale: 1;
        }

        /* Light mode override example (not active by default due to dark class) */
        .light-theme {
            --md-sys-color-primary: #415f91;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-surface: #f9f9ff;
            --md-sys-color-background: #f9f9ff;
            --md-sys-color-on-surface: #191c20;
            --md-sys-color-surface-variant: #e0e2ec;
        }

        body {
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-surface);
            font-size: calc(1rem * var(--font-scale));
            overflow: hidden; /* App-like feel */
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }
        
        .material-symbols-rounded.filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--md-sys-color-surface-variant);
            border-radius: 3px;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .slide-in { animation: slideIn 0.3s cubic-bezier(0.0, 0.0, 0.2, 1); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .ripple {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0);
        }
        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .ripple:active:after {
            transform: scale(0, 0);
            opacity: .1;
            transition: 0s;
        }

        .chat-bubble-self {
            border-radius: var(--bubble-radius) var(--bubble-radius) 4px var(--bubble-radius);
        }
        .chat-bubble-other {
            border-radius: var(--bubble-radius) var(--bubble-radius) var(--bubble-radius) 4px;
        }
        
        .glass-panel {
            background: rgba(17, 19, 24, 0.85);
            backdrop-filter: blur(12px);
        }

        /* Loader */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--md-sys-color-primary);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row antialiased selection:bg-md-sys-color-primary selection:text-md-sys-color-on-primary">

    <!-- Auth / Landing Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-md-sys-color-background p-6 text-center hidden">
        <img src="https://raw.githubusercontent.com/XtraDamage/minimum/refs/heads/main/logo_w_nobg.png" alt="Logo" class="w-32 h-32 mb-8 object-contain drop-shadow-lg">
        <h1 class="text-3xl font-bold mb-2">Minimum</h1>
        <p class="text-md-sys-color-on-surface-variant mb-8 max-w-sm">Быстрый. Безопасный. Минималистичный. <br>Войдите, чтобы начать общение.</p>
        <button id="google-login-btn" class="ripple flex items-center gap-3 bg-md-sys-color-primary text-md-sys-color-on-primary px-8 py-3 rounded-full font-medium shadow-lg hover:shadow-xl transition-all active:scale-95">
            <span class="material-symbols-rounded">login</span>
            Войти через Google
        </button>
    </div>

    <!-- Onboarding Screen -->
    <div id="onboarding-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-md-sys-color-background p-6 hidden">
        <div class="w-full max-w-md bg-md-sys-color-surfaceVariant/20 p-8 rounded-3xl border border-md-sys-color-outline/20">
            <h2 class="text-2xl font-bold mb-6 text-center">Создание профиля</h2>
            
            <div class="flex justify-center mb-6 relative group cursor-pointer" id="avatar-upload-area">
                <img id="onboarding-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover bg-md-sys-color-primaryContainer text-transparent" alt="Avatar">
                <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="material-symbols-rounded text-white">photo_camera</span>
                </div>
                <input type="file" id="onboarding-avatar-input" accept="image/*" class="hidden">
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-md-sys-color-primary ml-4 mb-1 block">Юзернейм (@username)</label>
                    <input type="text" id="onboarding-username" placeholder="ivan_pro" class="w-full bg-md-sys-color-surface p-4 rounded-2xl outline-none focus:ring-2 focus:ring-md-sys-color-primary transition-all">
                </div>
                <div>
                    <label class="text-xs text-md-sys-color-primary ml-4 mb-1 block">Отображаемое имя</label>
                    <input type="text" id="onboarding-nickname" placeholder="Ivan Ivanov" class="w-full bg-md-sys-color-surface p-4 rounded-2xl outline-none focus:ring-2 focus:ring-md-sys-color-primary transition-all">
                </div>
            </div>

            <button id="complete-onboarding-btn" class="w-full mt-8 bg-md-sys-color-primary text-md-sys-color-on-primary py-3 rounded-full font-bold hover:opacity-90 transition-opacity">
                Начать общение
            </button>
        </div>
    </div>

    <!-- Main App Layout -->
    <div id="app-container" class="w-full h-full flex hidden">
        
        <!-- Sidebar (User List / Settings / Search) -->
        <div id="sidebar" class="w-full md:w-80 lg:w-96 h-full flex flex-col border-r border-md-sys-color-outline/10 bg-md-sys-color-surface relative z-10">
            
            <!-- Header -->
            <div class="p-4 flex items-center gap-3">
                <button id="menu-btn" class="p-2 rounded-full hover:bg-white/5 transition-colors text-md-sys-color-on-surface">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                <div class="flex-1 relative">
                    <span class="material-symbols-rounded absolute left-3 top-2.5 text-md-sys-color-on-surface-variant text-lg">search</span>
                    <input id="global-search" type="text" placeholder="Поиск людей..." class="w-full bg-md-sys-color-surfaceVariant/30 pl-10 pr-4 py-2 rounded-full text-sm outline-none focus:bg-md-sys-color-surfaceVariant/50 transition-colors">
                </div>
            </div>

            <!-- Tabs/Filters (Optional) -->
            <!-- <div class="px-4 pb-2 flex gap-4 text-sm font-medium border-b border-md-sys-color-outline/10">
                <button class="text-md-sys-color-primary border-b-2 border-md-sys-color-primary pb-2">Все</button>
                <button class="text-md-sys-color-on-surface-variant hover:text-md-sys-color-on-surface pb-2">Личные</button>
            </div> -->

            <!-- Chat List -->
            <div id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Chats will be injected here -->
                <div class="text-center mt-10 text-md-sys-color-on-surface-variant text-sm animate-pulse">Загрузка чатов...</div>
            </div>
            
            <!-- Settings Overlay -->
            <div id="settings-panel" class="absolute inset-0 bg-md-sys-color-surface z-20 transform -translate-x-full transition-transform duration-300 flex flex-col">
                <div class="p-4 flex items-center gap-4 border-b border-md-sys-color-outline/10">
                    <button id="close-settings" class="p-2 rounded-full hover:bg-white/5"><span class="material-symbols-rounded">arrow_back</span></button>
                    <h2 class="text-lg font-medium">Настройки</h2>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-6">
                    
                    <!-- Profile Card -->
                    <div class="bg-md-sys-color-surfaceVariant/20 p-4 rounded-3xl flex items-center gap-4">
                        <img id="settings-avatar" src="" class="w-16 h-16 rounded-full object-cover bg-md-sys-color-primaryContainer">
                        <div>
                            <h3 id="settings-name" class="font-bold text-lg">Loading...</h3>
                            <p id="settings-username" class="text-sm text-md-sys-color-primary opacity-80">@loading</p>
                        </div>
                    </div>

                    <!-- Appearance -->
                    <div>
                        <h4 class="text-sm text-md-sys-color-primary font-bold uppercase mb-3 ml-2">Оформление</h4>
                        <div class="bg-md-sys-color-surfaceVariant/10 rounded-2xl p-4 space-y-4">
                            <div>
                                <label class="flex justify-between text-sm mb-2"><span>Размер текста</span> <span id="font-size-val">100%</span></label>
                                <input type="range" min="0.8" max="1.3" step="0.05" value="1" id="font-size-slider" class="w-full accent-md-sys-color-primary">
                            </div>
                            <div>
                                <label class="flex justify-between text-sm mb-2"><span>Скругление сообщений</span></label>
                                <div class="flex gap-2">
                                    <button class="flex-1 py-2 rounded-lg bg-md-sys-color-surfaceVariant/30 text-xs bubble-rad-btn" data-val="0.5rem">Min</button>
                                    <button class="flex-1 py-2 rounded-lg bg-md-sys-color-primary text-md-sys-color-on-primary text-xs bubble-rad-btn" data-val="1.5rem">Norm</button>
                                    <button class="flex-1 py-2 rounded-lg bg-md-sys-color-surfaceVariant/30 text-xs bubble-rad-btn" data-val="2rem">Max</button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span>Цветовой акцент</span>
                                <input type="color" id="accent-color-picker" value="#a8c7fa" class="w-8 h-8 rounded-full overflow-hidden border-none outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <button id="logout-btn" class="w-full py-3 rounded-2xl bg-red-500/10 text-red-400 font-medium hover:bg-red-500/20 transition">Выйти из аккаунта</button>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-area" class="flex-1 flex flex-col bg-black relative transform translate-x-full md:translate-x-0 transition-transform duration-300 absolute inset-0 md:static z-20">
            
            <!-- Empty State -->
            <div id="empty-chat-state" class="absolute inset-0 flex flex-col items-center justify-center bg-md-sys-color-background z-0">
                <div class="w-24 h-24 bg-md-sys-color-surfaceVariant/20 rounded-full flex items-center justify-center mb-4">
                    <span class="material-symbols-rounded text-4xl text-md-sys-color-outline">chat_bubble_outline</span>
                </div>
                <p class="text-md-sys-color-on-surface-variant">Выберите чат или найдите пользователя</p>
            </div>

            <!-- Chat Content -->
            <div id="active-chat-container" class="flex flex-col h-full hidden bg-[url('https://i.pinimg.com/originals/97/c0/07/97c00759d90d786d9b6096d274ad3e07.png')] bg-cover bg-center">
                <div class="absolute inset-0 bg-md-sys-color-background/90 backdrop-blur-sm pointer-events-none"></div>

                <!-- Chat Header -->
                <div class="relative z-10 glass-panel p-3 flex items-center gap-4 border-b border-white/5">
                    <button id="back-to-list-btn" class="md:hidden p-2 rounded-full hover:bg-white/10"><span class="material-symbols-rounded">arrow_back</span></button>
                    <img id="chat-header-avatar" src="" class="w-10 h-10 rounded-full bg-md-sys-color-surfaceVariant">
                    <div class="flex-1 cursor-pointer hover:opacity-80 transition" id="chat-header-info">
                        <h3 id="chat-header-name" class="font-bold text-md leading-tight">User</h3>
                        <p id="chat-header-status" class="text-xs text-md-sys-color-primary">в сети</p>
                    </div>
                    <button class="p-2 rounded-full hover:bg-white/10"><span class="material-symbols-rounded">more_vert</span></button>
                </div>

                <!-- Messages -->
                <div id="messages-container" class="relative z-10 flex-1 overflow-y-auto p-4 space-y-2 scroll-smooth">
                    <!-- Messages go here -->
                </div>

                <!-- Input Area -->
                <div class="relative z-10 glass-panel p-2 md:p-4 flex flex-col gap-2 border-t border-white/5">
                    <!-- Reply Preview -->
                    <div id="reply-preview" class="hidden flex items-center gap-3 p-2 bg-md-sys-color-surface/50 rounded-lg mb-1 border-l-4 border-md-sys-color-primary">
                        <span class="material-symbols-rounded text-md-sys-color-primary">reply</span>
                        <div class="flex-1 overflow-hidden">
                            <p class="text-xs text-md-sys-color-primary font-bold">Ответ</p>
                            <p id="reply-text-preview" class="text-xs truncate opacity-70">Message content</p>
                        </div>
                        <button id="cancel-reply" class="p-1"><span class="material-symbols-rounded text-sm">close</span></button>
                    </div>

                    <div class="flex items-end gap-2">
                        <button id="attach-btn" class="p-3 text-md-sys-color-on-surface-variant hover:text-md-sys-color-primary transition-colors">
                            <span class="material-symbols-rounded">attach_file</span>
                        </button>
                        <input type="file" id="file-input" class="hidden" accept="image/*, audio/*">
                        
                        <div class="flex-1 bg-md-sys-color-surfaceVariant/30 rounded-3xl flex items-center min-h-[48px] px-4 py-2">
                            <textarea id="message-input" rows="1" placeholder="Сообщение" class="w-full bg-transparent border-none outline-none resize-none max-h-32 text-sm pt-1"></textarea>
                        </div>
                        
                        <button id="send-btn" class="p-3 rounded-full bg-md-sys-color-primary text-md-sys-color-on-primary hover:shadow-lg hover:scale-105 transition-all flex items-center justify-center">
                            <span class="material-symbols-rounded filled">send</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="context-menu" class="fixed hidden z-50 bg-md-sys-color-surfaceVariant rounded-xl shadow-2xl py-2 w-48 border border-white/5 backdrop-blur-md">
        <button class="w-full text-left px-4 py-2 hover:bg-white/10 flex items-center gap-3 text-sm" id="ctx-reply">
            <span class="material-symbols-rounded text-lg">reply</span> Ответить
        </button>
        <button class="w-full text-left px-4 py-2 hover:bg-white/10 flex items-center gap-3 text-sm" id="ctx-copy">
            <span class="material-symbols-rounded text-lg">content_copy</span> Копировать
        </button>
        <button class="w-full text-left px-4 py-2 hover:bg-white/10 flex items-center gap-3 text-sm text-red-400 hidden" id="ctx-delete">
            <span class="material-symbols-rounded text-lg">delete</span> Удалить
        </button>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-md-sys-color-on-surface text-md-sys-color-surface px-6 py-3 rounded-full shadow-lg z-[100] opacity-0 pointer-events-none transition-opacity text-sm font-medium">
        Notification
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, where, updateDoc, deleteDoc, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuP_aYZpqJ-Y8LINCIywCFw3G2ZYVExv4",
            authDomain: "msgr-minimum.firebaseapp.com",
            projectId: "msgr-minimum",
            storageBucket: "msgr-minimum.firebasestorage.app",
            messagingSenderId: "583321384135",
            appId: "1:583321384135:web:2b9f7cae0f37419341fae2",
            measurementId: "G-2FFQC74VG6"
        };
        const appId = "minimum-web"; // Custom ID for the artifacts path rule

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let currentUser = null;
        let currentUserData = null;
        let activeChatId = null;
        let activeChatUser = null;
        let replyToMessage = null;
        let listeners = [];
        
        // --- Helper: Path Builders (Strict Compliance) ---
        // Rule: /artifacts/{appId}/public/data/{collectionName}
        // Using PUBLIC path for everything in this demo so users can find each other and share chats
        const getPublicColl = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getPublicDoc = (collName, docId) => doc(db, 'artifacts', appId, 'public', 'data', collName, docId);

        // --- DOM Elements ---
        const screens = {
            auth: document.getElementById('auth-screen'),
            onboarding: document.getElementById('onboarding-screen'),
            app: document.getElementById('app-container')
        };
        
        // --- UI Logic ---
        function showScreen(name) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[name].classList.remove('hidden');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }

        // --- Authentication ---
        const loginBtn = document.getElementById('google-login-btn');
        loginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                showToast("Ошибка входа: " + error.message);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
            window.location.reload();
        });

        // --- Onboarding Logic ---
        let onboardingAvatarBase64 = "";

        document.getElementById('avatar-upload-area').addEventListener('click', () => {
            document.getElementById('onboarding-avatar-input').click();
        });

        document.getElementById('onboarding-avatar-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if(file.size > 200000) { showToast("Файл слишком большой (>200KB)"); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    onboardingAvatarBase64 = e.target.result;
                    document.getElementById('onboarding-avatar-preview').src = onboardingAvatarBase64;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('complete-onboarding-btn').addEventListener('click', async () => {
            const username = document.getElementById('onboarding-username').value.trim().toLowerCase();
            const nickname = document.getElementById('onboarding-nickname').value.trim();

            if (!username || !nickname) {
                showToast("Заполните все поля");
                return;
            }

            // Simple uniqueness check (in production should use transactions or cloud functions)
            // For this demo, we just overwrite/create.
            
            const userData = {
                uid: currentUser.uid,
                email: currentUser.email,
                username: username,
                nickname: nickname,
                avatar: onboardingAvatarBase64 || `https://ui-avatars.com/api/?name=${nickname}&background=random`,
                createdAt: serverTimestamp(),
                settings: {
                    accentColor: '#a8c7fa',
                    bubbleRadius: '1.5rem',
                    fontSize: 1
                }
            };

            await setDoc(getPublicDoc('users', currentUser.uid), userData);
            currentUserData = userData;
            applySettings(userData.settings);
            showScreen('app');
            initApp();
        });

        // --- Main App Logic ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Check if profile exists
                const userDocSnap = await getDoc(getPublicDoc('users', user.uid));
                if (userDocSnap.exists()) {
                    currentUserData = userDocSnap.data();
                    applySettings(currentUserData.settings);
                    showScreen('app');
                    initApp();
                } else {
                    showScreen('onboarding');
                }
            } else {
                currentUser = null;
                showScreen('auth');
            }
        });

        function applySettings(settings) {
            if(!settings) return;
            const root = document.documentElement;
            if(settings.accentColor) root.style.setProperty('--md-sys-color-primary', settings.accentColor);
            if(settings.bubbleRadius) root.style.setProperty('--bubble-radius', settings.bubbleRadius);
            if(settings.fontSize) root.style.setProperty('--font-scale', settings.fontSize);

            // Update UI elements in settings panel
            document.getElementById('font-size-slider').value = settings.fontSize || 1;
            document.getElementById('accent-color-picker').value = settings.accentColor || '#a8c7fa';
        }

        async function initApp() {
            loadChats();
            setupSearch();
            setupSettingsUI();
        }

        // --- Chats List ---
        function loadChats() {
            const listEl = document.getElementById('chat-list');
            
            // Query all chats (In a real scalable app, we'd duplicate chat metadata to user's private subcollection)
            // Here we verify logic in JS due to simplified structure
            const q = query(getPublicColl('chats')); // We fetch all then filter. Not scalable but works for demo.
            
            const unsub = onSnapshot(q, (snapshot) => {
                const chats = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.participants && data.participants.includes(currentUser.uid)) {
                        chats.push({ id: doc.id, ...data });
                    }
                });

                // Sort by last message time locally
                chats.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));

                renderChatList(chats);
            });
            listeners.push(unsub);
        }

        async function renderChatList(chats) {
            const listEl = document.getElementById('chat-list');
            listEl.innerHTML = '';
            
            // Add "Saved Messages" (Chat with self)
            const savedChat = chats.find(c => c.participants.length === 2 && c.participants[0] === currentUser.uid && c.participants[1] === currentUser.uid);
            
            const favEl = document.createElement('div');
            favEl.className = `p-3 flex items-center gap-3 rounded-2xl cursor-pointer hover:bg-md-sys-color-surfaceVariant/20 transition-colors ${activeChatId === (savedChat?.id || 'saved') ? 'bg-md-sys-color-primaryContainer/30' : ''}`;
            favEl.innerHTML = `
                <div class="w-12 h-12 rounded-full bg-md-sys-color-primaryContainer flex items-center justify-center text-md-sys-color-primary">
                    <span class="material-symbols-rounded">bookmark</span>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-sm">Избранное</h4>
                    <p class="text-xs text-md-sys-color-on-surface-variant">Сохраненные сообщения</p>
                </div>
            `;
            favEl.onclick = () => openChat(currentUser.uid, 'saved'); // Special flag
            listEl.appendChild(favEl);

            for (const chat of chats) {
                // Find other user ID
                const otherId = chat.participants.find(id => id !== currentUser.uid);
                if (!otherId) continue; // Skip saved messages logic here

                // Need to fetch user data for display (cache this in real app)
                let otherUser = { nickname: 'User', avatar: '' };
                try {
                    const uSnap = await getDoc(getPublicDoc('users', otherId));
                    if(uSnap.exists()) otherUser = uSnap.data();
                } catch(e) {}

                const el = document.createElement('div');
                el.className = `p-3 flex items-center gap-3 rounded-2xl cursor-pointer hover:bg-md-sys-color-surfaceVariant/20 transition-colors ${activeChatId === chat.id ? 'bg-md-sys-color-primaryContainer/30' : ''}`;
                
                const lastMsg = chat.lastMessageText || 'Нет сообщений';
                const time = chat.lastUpdated ? new Date(chat.lastUpdated.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

                el.innerHTML = `
                    <img src="${otherUser.avatar}" class="w-12 h-12 rounded-full object-cover bg-gray-700">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline">
                            <h4 class="font-bold text-sm truncate">${otherUser.nickname}</h4>
                            <span class="text-[10px] text-md-sys-color-outline">${time}</span>
                        </div>
                        <p class="text-xs text-md-sys-color-on-surface-variant truncate ${chat.unread?.[currentUser.uid] ? 'text-md-sys-color-primary font-bold' : ''}">${lastMsg}</p>
                    </div>
                `;
                el.onclick = () => openChat(otherId, chat.id);
                listEl.appendChild(el);
            }
        }

        // --- Search Logic ---
        function setupSearch() {
            const searchInput = document.getElementById('global-search');
            let debounce;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounce);
                const val = e.target.value.toLowerCase();
                if(!val) { loadChats(); return; }

                debounce = setTimeout(async () => {
                    const listEl = document.getElementById('chat-list');
                    listEl.innerHTML = '<div class="text-center p-4 text-xs">Поиск...</div>';
                    
                    // Simple full scan of users (Demo limitation, ideally use Algolia or specialized index)
                    const q = query(getPublicColl('users')); 
                    const snap = await getDoc(getPublicDoc('users', 'dummy')); // Trigger read? No, use getDocs not available in slim imports easily.
                    
                    // Fallback: Using onSnapshot for query just once
                     onSnapshot(q, (snapshot) => {
                         listEl.innerHTML = '';
                         let found = false;
                         snapshot.forEach(doc => {
                             const u = doc.data();
                             if (u.uid !== currentUser.uid && (u.username.includes(val) || u.nickname.toLowerCase().includes(val))) {
                                found = true;
                                const el = document.createElement('div');
                                el.className = `p-3 flex items-center gap-3 rounded-2xl cursor-pointer hover:bg-md-sys-color-surfaceVariant/20 transition-colors`;
                                el.innerHTML = `
                                    <img src="${u.avatar}" class="w-12 h-12 rounded-full object-cover">
                                    <div class="flex-1">
                                        <h4 class="font-bold text-sm text-md-sys-color-primary">${u.nickname}</h4>
                                        <p class="text-xs text-md-sys-color-on-surface-variant">@${u.username}</p>
                                    </div>
                                `;
                                el.onclick = () => openChat(u.uid);
                                listEl.appendChild(el);
                             }
                         });
                         if(!found) listEl.innerHTML = '<div class="text-center p-4 text-xs opacity-50">Ничего не найдено</div>';
                     });
                }, 500);
            });
        }

        // --- Chat Logic ---
        async function openChat(targetUid, existingChatId = null) {
            // UI Switch
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }
            document.getElementById('empty-chat-state').classList.add('hidden');
            const chatContainer = document.getElementById('active-chat-container');
            chatContainer.classList.remove('hidden');
            chatContainer.classList.add('fade-in');

            // Load Target User Data
            let targetUser = currentUserData; // Default to self
            if (targetUid !== currentUser.uid) {
                const snap = await getDoc(getPublicDoc('users', targetUid));
                targetUser = snap.data();
            }
            activeChatUser = targetUser;

            // Update Header
            document.getElementById('chat-header-name').textContent = targetUser.nickname || 'Избранное';
            document.getElementById('chat-header-avatar').src = targetUser.avatar;
            document.getElementById('chat-header-status').textContent = targetUid === currentUser.uid ? 'Облачное хранилище' : '@' + targetUser.username;

            // Resolve Chat ID
            let chatId = existingChatId;
            if (!chatId) {
                // Check if chat exists
                // We construct a composite ID to avoid querying. ID = uid1_uid2 (sorted)
                const ids = [currentUser.uid, targetUid].sort();
                chatId = ids.join('_');
            }
            
            // Special case for Saved Messages
            if(targetUid === currentUser.uid && existingChatId === 'saved') {
                chatId = `${currentUser.uid}_${currentUser.uid}`;
            }

            activeChatId = chatId;
            loadMessages(chatId);
            
            // Ensure chat doc exists
            const chatRef = getPublicDoc('chats', chatId);
            const chatSnap = await getDoc(chatRef);
            if (!chatSnap.exists()) {
                await setDoc(chatRef, {
                    participants: [currentUser.uid, targetUid],
                    createdAt: serverTimestamp(),
                    lastUpdated: serverTimestamp()
                });
            }
        }

        function loadMessages(chatId) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            
            // Unsubscribe previous message listener
            if (window.msgUnsub) window.msgUnsub();

            const q = query(getPublicColl('messages'), where('chatId', '==', chatId)); // orderBy requires index, we sort in memory for demo
            
            window.msgUnsub = onSnapshot(q, (snapshot) => {
                const msgs = [];
                snapshot.forEach(doc => msgs.push({id: doc.id, ...doc.data()}));
                // Sort
                msgs.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                renderMessages(msgs);
            });
        }

        function renderMessages(msgs) {
            const container = document.getElementById('messages-container');
            const wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 50;
            
            container.innerHTML = '';
            
            msgs.forEach(msg => {
                const isMe = msg.senderId === currentUser.uid;
                const bubble = document.createElement('div');
                bubble.className = `flex w-full mb-2 ${isMe ? 'justify-end' : 'justify-start'} group`;
                
                let contentHtml = '';
                
                // Reply Context
                if (msg.replyTo) {
                    contentHtml += `
                        <div class="mb-1 border-l-2 ${isMe ? 'border-white/50' : 'border-md-sys-color-primary'} pl-2 cursor-pointer opacity-75 text-xs">
                            <div class="font-bold">${msg.replyTo.name}</div>
                            <div class="truncate">${msg.replyTo.text}</div>
                        </div>
                    `;
                }

                // Attachments
                if (msg.attachment) {
                    if (msg.attachment.type.startsWith('image')) {
                        contentHtml += `<img src="${msg.attachment.data}" class="rounded-lg max-w-[200px] mb-1 cursor-pointer hover:opacity-90">`;
                    }
                }

                // Text
                contentHtml += `<div class="whitespace-pre-wrap break-words text-sm">${msg.text}</div>`;
                
                // Meta
                const time = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                contentHtml += `<div class="text-[10px] text-right opacity-60 mt-1 flex justify-end items-center gap-1">${msg.isEdited ? '<span class="material-symbols-rounded text-[10px]">edit</span>' : ''} ${time}</div>`;

                bubble.innerHTML = `
                    <div class="max-w-[75%] p-3 ${isMe ? 'bg-md-sys-color-primary text-md-sys-color-on-primary chat-bubble-self' : 'bg-md-sys-color-surfaceVariant text-md-sys-color-on-surfaceVariant chat-bubble-other'} shadow-sm relative transition-all" data-id="${msg.id}">
                        ${contentHtml}
                    </div>
                `;

                // Context Menu Event
                const bubbleContent = bubble.querySelector('div');
                bubbleContent.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, msg, isMe);
                });

                container.appendChild(bubble);
            });

            if (wasAtBottom) container.scrollTop = container.scrollHeight;
        }

        // --- Sending Messages ---
        const msgInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const fileInput = document.getElementById('file-input');
        let currentAttachment = null;

        // Auto resize textarea
        msgInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        document.getElementById('attach-btn').addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 300000) { // 300KB limit for base64
                    showToast("Файл слишком большой для демо-версии");
                    return;
                }
                const reader = new FileReader();
                reader.onload = (evt) => {
                    currentAttachment = {
                        type: file.type,
                        name: file.name,
                        data: evt.target.result
                    };
                    showToast("Файл прикреплен");
                    document.getElementById('attach-btn').classList.add('text-md-sys-color-primary');
                };
                reader.readAsDataURL(file);
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const text = msgInput.value.trim();
            if (!text && !currentAttachment) return;
            if (!activeChatId) return;

            const msgData = {
                chatId: activeChatId,
                senderId: currentUser.uid,
                text: text,
                attachment: currentAttachment,
                createdAt: serverTimestamp(),
                replyTo: replyToMessage ? { id: replyToMessage.id, text: replyToMessage.text, name: replyToMessage.senderId === currentUser.uid ? 'Вы' : activeChatUser.nickname } : null,
                isEdited: false
            };

            // Reset UI immediately
            msgInput.value = '';
            msgInput.style.height = 'auto';
            currentAttachment = null;
            document.getElementById('attach-btn').classList.remove('text-md-sys-color-primary');
            cancelReply();

            // Optimistic Update (Handled by snapshot listener, but we send to DB)
            try {
                await addDoc(getPublicColl('messages'), msgData);
                
                // Update Chat Last Message
                await updateDoc(getPublicDoc('chats', activeChatId), {
                    lastMessageText: text || 'Вложение',
                    lastUpdated: serverTimestamp()
                });
            } catch (e) {
                console.error(e);
                showToast("Ошибка отправки");
            }
        }

        // --- Context Menu & Actions ---
        const ctxMenu = document.getElementById('context-menu');
        let ctxTargetMsg = null;

        function showContextMenu(x, y, msg, isMe) {
            ctxTargetMsg = msg;
            ctxMenu.style.left = `${Math.min(x, window.innerWidth - 200)}px`;
            ctxMenu.style.top = `${Math.min(y, window.innerHeight - 150)}px`;
            ctxMenu.classList.remove('hidden');
            
            document.getElementById('ctx-delete').classList.toggle('hidden', !isMe);
        }

        document.addEventListener('click', (e) => {
            if (!ctxMenu.contains(e.target)) ctxMenu.classList.add('hidden');
        });

        document.getElementById('ctx-copy').onclick = () => {
            navigator.clipboard.writeText(ctxTargetMsg.text);
            ctxMenu.classList.add('hidden');
            showToast("Скопировано");
        };

        document.getElementById('ctx-delete').onclick = async () => {
            if (confirm('Удалить сообщение?')) {
                await deleteDoc(getPublicDoc('messages', ctxTargetMsg.id));
            }
            ctxMenu.classList.add('hidden');
        };

        document.getElementById('ctx-reply').onclick = () => {
            replyToMessage = ctxTargetMsg;
            document.getElementById('reply-preview').classList.remove('hidden');
            document.getElementById('reply-text-preview').textContent = ctxTargetMsg.text;
            msgInput.focus();
            ctxMenu.classList.add('hidden');
        };

        function cancelReply() {
            replyToMessage = null;
            document.getElementById('reply-preview').classList.add('hidden');
        }
        document.getElementById('cancel-reply').onclick = cancelReply;

        // --- Navigation Mobile ---
        document.getElementById('back-to-list-btn').addEventListener('click', () => {
            document.getElementById('active-chat-container').classList.add('hidden');
            document.getElementById('empty-chat-state').classList.remove('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            activeChatId = null;
        });

        // --- Settings Panel ---
        const settingsPanel = document.getElementById('settings-panel');
        document.getElementById('menu-btn').addEventListener('click', () => {
            settingsPanel.classList.remove('-translate-x-full');
            // Load user data into settings
            document.getElementById('settings-name').textContent = currentUserData.nickname;
            document.getElementById('settings-username').textContent = '@' + currentUserData.username;
            document.getElementById('settings-avatar').src = currentUserData.avatar;
        });

        document.getElementById('close-settings').addEventListener('click', () => {
            settingsPanel.classList.add('-translate-x-full');
        });

        function setupSettingsUI() {
            // Font Size
            document.getElementById('font-size-slider').addEventListener('input', (e) => {
                const val = e.target.value;
                document.getElementById('font-size-val').textContent = Math.round(val * 100) + '%';
                document.documentElement.style.setProperty('--font-scale', val);
                saveSetting('fontSize', val);
            });

            // Accent Color
            document.getElementById('accent-color-picker').addEventListener('change', (e) => {
                document.documentElement.style.setProperty('--md-sys-color-primary', e.target.value);
                saveSetting('accentColor', e.target.value);
            });

            // Bubble Radius
            document.querySelectorAll('.bubble-rad-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Reset buttons
                    document.querySelectorAll('.bubble-rad-btn').forEach(b => {
                        b.classList.remove('bg-md-sys-color-primary', 'text-md-sys-color-on-primary');
                        b.classList.add('bg-md-sys-color-surfaceVariant/30');
                    });
                    // Set active
                    btn.classList.remove('bg-md-sys-color-surfaceVariant/30');
                    btn.classList.add('bg-md-sys-color-primary', 'text-md-sys-color-on-primary');
                    
                    const val = btn.dataset.val;
                    document.documentElement.style.setProperty('--bubble-radius', val);
                    saveSetting('bubbleRadius', val);
                });
            });
        }

        async function saveSetting(key, val) {
            if (!currentUser) return;
            const update = {};
            update[`settings.${key}`] = val;
            await updateDoc(getPublicDoc('users', currentUser.uid), update);
        }

    </script>
</body>
</html>

