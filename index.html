<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>minimum</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs (Compat v9/v10) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', '-apple-system', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        bg: 'var(--bg)',
                        surface: 'var(--surface)',
                        border: 'var(--border)',
                        text: 'var(--text)',
                        muted: 'var(--muted)',
                        accent: 'var(--accent)',
                        msgOwn: 'var(--msg-own)',
                        msgOwnText: 'var(--msg-own-text)',
                        msgOther: 'var(--msg-other)',
                        danger: '#ef4444'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&display=swap');

        /* THEMES */
        :root[data-theme="dark"] {
            --bg: #000000;
            --surface: #121212;
            --border: #262626;
            --text: #ffffff;
            --muted: #666666;
            --accent: #ffffff;
            --msg-own: #ffffff;
            --msg-own-text: #000000;
            --msg-other: #1c1c1c;
        }

        :root[data-theme="light"] {
            --bg: #ffffff;
            --surface: #f3f4f6;
            --border: #e5e7eb;
            --text: #000000;
            --muted: #9ca3af;
            --accent: #000000;
            --msg-own: #000000;
            --msg-own-text: #ffffff;
            --msg-other: #f3f4f6;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh; /* Dynamic viewport height fix for mobile */
            width: 100vw;
            overflow: hidden;
        }

        /* Clean Scrollbar */
        .scroll-clean::-webkit-scrollbar { width: 4px; }
        .scroll-clean::-webkit-scrollbar-track { background: transparent; }
        .scroll-clean::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* Inputs */
        .input-clean {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            border-radius: 0;
            transition: border-color 0.2s;
            font-family: 'JetBrains Mono', monospace;
        }
        .input-clean:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Message Bubbles */
        .msg-bubble {
            max-width: 80%;
            padding: 10px 14px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }
        .msg-own {
            background: var(--msgOwn);
            color: var(--msgOwnText);
            border-radius: 18px 18px 4px 18px;
        }
        .msg-other {
            background: var(--msgOther);
            color: var(--text);
            border-radius: 18px 18px 18px 4px;
        }

        /* Audio Player */
        .waveform {
            display: flex; gap: 2px; align-items: center; height: 16px;
        }
        .bar {
            width: 2px; background: currentColor; opacity: 0.6;
            animation: wave 1s infinite ease-in-out;
        }
        @keyframes wave { 0%, 100% { height: 4px; } 50% { height: 100%; } }

        /* Error Overlay */
        #errorOverlay {
            display: none;
        }
    </style>
</head>
<body class="flex flex-col antialiased">

    <!-- ERROR OVERLAY (Failsafe) -->
    <div id="errorOverlay" class="fixed inset-0 z-[9999] bg-black text-red-500 p-10 font-mono text-xs flex flex-col justify-center">
        <h1 class="text-xl mb-4 font-bold">CRITICAL ERROR</h1>
        <div id="errorText"></div>
        <button onclick="location.reload()" class="mt-8 border border-red-500 px-4 py-2 hover:bg-red-900/20">RELOAD SYSTEM</button>
    </div>

    <!-- BOOT LOADER -->
    <div id="bootScreen" class="fixed inset-0 z-[100] bg-bg flex items-center justify-center transition-opacity duration-500">
        <img id="bootLogo" src="logo_w_nobg.png" class="w-20 h-20 object-contain animate-pulse">
    </div>

    <!-- AUTH VIEW -->
    <div id="viewAuth" class="fixed inset-0 z-50 bg-bg flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-700">
        <div class="w-full max-w-sm p-8 flex flex-col items-center animate-slide-up">
            <img id="authLogo" src="logo_w_nobg.png" class="w-32 h-32 object-contain mb-8 hover:scale-105 transition-transform duration-500">
            <h1 class="text-4xl font-light mb-12 tracking-tighter">minimum</h1>
            
            <button id="btnGoogle" class="w-full h-14 rounded-xl bg-surface border border-border flex items-center justify-center gap-3 hover:border-accent transition-all active:scale-[0.98] group">
                <svg class="w-5 h-5 text-text group-hover:scale-110 transition-transform" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.8-3.5 5.4-6.5 5.4C8.92 19.23 6 16.05 6 12c0-4.17 3-7.2 7.2-7.2 2.74 0 4.93.99 6.2 2.18l2.7-2.7c-2.4-2.2-5.9-3.4-8.9-3.4C4.8 1 0 5.1 0 12c0 6.9 4.8 11 11.9 11 6.8 0 11.6-4.7 11.6-11.3 0-.8-.1-1.5-.2-2.3z"/></svg>
                <span class="font-medium text-sm">Войти через Google</span>
            </button>
        </div>
    </div>

    <!-- APP VIEW -->
    <div id="viewApp" class="flex-1 flex overflow-hidden relative opacity-0 transition-opacity duration-500 hidden">
        
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-full md:w-[380px] bg-bg border-r border-border flex flex-col h-full z-10 absolute md:relative transition-transform duration-300 md:transform-none">
            
            <!-- Sidebar Header -->
            <div class="h-16 min-h-[64px] px-4 flex items-center justify-between border-b border-border bg-bg/95 backdrop-blur z-20 sticky top-0">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="app.openSettings()">
                    <div class="relative w-9 h-9">
                        <img id="myAvatar" class="w-full h-full rounded-full object-cover border border-border bg-surface">
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-bg"></div>
                    </div>
                    <div class="flex flex-col">
                        <span id="myNameDisplay" class="text-sm font-semibold leading-tight">...</span>
                        <span class="text-[10px] text-muted font-mono tracking-wider">ONLINE</span>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button class="p-2 rounded-full hover:bg-surface text-muted hover:text-text transition-colors" onclick="app.toggleTheme()">
                        <i id="iconTheme" data-lucide="sun" class="w-5 h-5"></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-surface text-muted hover:text-text transition-colors" onclick="app.openSearch()">
                        <i data-lucide="edit" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="p-4">
                <div class="h-10 bg-surface rounded-xl flex items-center px-3 gap-3 border border-transparent focus-within:border-border transition-colors">
                    <i data-lucide="search" class="w-4 h-4 text-muted"></i>
                    <input type="text" placeholder="Поиск" class="bg-transparent border-none outline-none text-sm w-full placeholder-muted h-full" id="filterChatInput">
                </div>
            </div>

            <!-- Chat List -->
            <div id="chatList" class="flex-1 overflow-y-auto scroll-clean pb-4 space-y-0.5 px-2">
                <!-- Chats will appear here -->
            </div>
        </div>

        <!-- CHAT INTERFACE -->
        <div id="chatInterface" class="absolute inset-0 z-20 bg-bg flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300 md:static md:flex-1">
            
            <!-- Chat Header -->
            <div class="h-16 min-h-[64px] px-4 flex items-center justify-between border-b border-border bg-bg/95 backdrop-blur z-30">
                <div class="flex items-center gap-3 cursor-pointer" onclick="app.showChatInfo()">
                    <button class="md:hidden -ml-2 p-2 text-muted hover:text-text" onclick="event.stopPropagation(); app.closeChat()">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                    <img id="chatAvatar" class="w-9 h-9 rounded-full bg-surface object-cover">
                    <div>
                        <div id="chatName" class="font-medium text-sm">User</div>
                        <div class="text-[10px] text-muted font-mono">ENCRYPTED</div>
                    </div>
                </div>
                <button class="p-2 text-muted hover:text-text rounded-full hover:bg-surface" onclick="app.toggleChatMenu()">
                    <i data-lucide="more-vertical" class="w-5 h-5"></i>
                </button>
                
                <!-- Chat Context Menu -->
                <div id="chatMenu" class="absolute top-14 right-4 w-56 bg-bg border border-border rounded-xl shadow-2xl hidden flex-col py-1 z-50 animate-fade-in">
                    <button class="px-4 py-3 text-left text-sm hover:bg-surface flex items-center gap-2" onclick="app.clearChat(false)">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Очистить у себя
                    </button>
                    <button class="px-4 py-3 text-left text-sm hover:bg-surface flex items-center gap-2" onclick="app.clearChat(true)">
                        <i data-lucide="trash" class="w-4 h-4"></i> Очистить у всех
                    </button>
                    <div class="h-[1px] bg-border my-1"></div>
                    <button class="px-4 py-3 text-left text-sm text-danger hover:bg-red-500/10 flex items-center gap-2" onclick="app.blockUser()">
                        <i data-lucide="ban" class="w-4 h-4"></i> Заблокировать
                    </button>
                    <button class="px-4 py-3 text-left text-sm text-danger hover:bg-red-500/10 flex items-center gap-2" onclick="app.deleteChat()">
                        <i data-lucide="x-circle" class="w-4 h-4"></i> Удалить чат
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-2 scroll-clean bg-bg" onclick="app.hideChatMenu()">
                <!-- Messages -->
            </div>

            <!-- Edit Indicator -->
            <div id="editIndicator" class="hidden px-4 py-2 bg-surface border-t border-border flex justify-between items-center text-xs">
                <span class="flex items-center gap-2 text-accent"><i data-lucide="pencil" class="w-3 h-3"></i> Редактирование</span>
                <button onclick="app.cancelEdit()"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <!-- Input Area -->
            <div class="p-3 md:p-4 bg-bg border-t border-border z-30">
                <div class="flex items-end gap-2 bg-surface p-1.5 rounded-[20px] border border-border transition-colors focus-within:border-muted">
                    <input type="file" id="fileInput" class="hidden" onchange="app.handleFileUpload(this)">
                    <button class="p-2.5 text-muted hover:text-text transition-colors rounded-full hover:bg-bg" onclick="document.getElementById('fileInput').click()">
                        <i data-lucide="paperclip" class="w-5 h-5"></i>
                    </button>
                    
                    <textarea id="msgInput" rows="1" placeholder="Сообщение..." class="flex-1 bg-transparent border-none outline-none text-[15px] py-2.5 px-1 max-h-32 resize-none placeholder-muted" style="min-height: 24px;"></textarea>
                    
                    <button id="btnMic" class="p-2.5 text-muted hover:text-text transition-colors rounded-full hover:bg-bg" onclick="app.toggleRecording()">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                    </button>
                    
                    <button id="btnSend" class="hidden p-2.5 bg-accent text-bg rounded-full hover:opacity-90 transition-all active:scale-95" onclick="app.sendMessage()">
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <!-- Empty State for Desktop -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center bg-bg z-10 md:flex hidden">
                <span class="text-xs font-mono tracking-[0.2em] text-muted">SELECT A CHAT</span>
            </div>
        </div>

    </div>

    <!-- MODALS -->

    <!-- Search Modal -->
    <div id="modalSearch" class="fixed inset-0 z-50 bg-bg/90 backdrop-blur-sm hidden flex pt-24 justify-center px-4" onclick="if(event.target === this) app.closeSearch()">
        <div class="w-full max-w-md bg-bg border border-border rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            <div class="flex items-center border-b border-border p-3 gap-3">
                <i data-lucide="search" class="w-5 h-5 text-muted ml-2"></i>
                <input id="userSearchInput" class="flex-1 bg-transparent outline-none h-10 text-sm placeholder-muted" placeholder="Поиск пользователя (@username)">
                <button onclick="app.closeSearch()" class="p-2 hover:bg-surface rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="searchResults" class="min-h-[100px] max-h-[300px] overflow-y-auto p-2"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modalSettings" class="fixed inset-0 z-50 bg-bg hidden flex flex-col translate-y-full transition-transform duration-300">
        <div class="h-16 px-4 flex items-center justify-between border-b border-border">
            <h2 class="font-bold">Settings</h2>
            <button onclick="app.closeSettings()" class="p-2 rounded-full hover:bg-surface"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 max-w-2xl mx-auto w-full">
            <div class="flex flex-col items-center mb-10">
                <div class="relative w-28 h-28 mb-4 group cursor-pointer">
                    <img id="settingsAvatar" class="w-full h-full rounded-full object-cover border-2 border-border group-hover:border-accent transition-colors">
                    <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="camera" class="w-8 h-8 text-white"></i>
                    </div>
                    <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="app.updateAvatar(this)">
                </div>
                <h3 id="settingsName" class="text-xl font-bold">Name</h3>
                <p id="settingsUsername" class="text-muted font-mono text-sm">@username</p>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="text-[10px] uppercase font-bold text-muted tracking-wider block mb-2">Display Name</label>
                    <input id="editName" class="w-full input-clean py-2 text-lg">
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-muted tracking-wider block mb-2">Username</label>
                    <input id="editUsername" class="w-full input-clean py-2 text-lg font-mono">
                </div>
                
                <button onclick="app.saveProfile()" class="w-full py-3 bg-accent text-bg rounded-xl font-bold mt-4">Save Changes</button>
                
                <div class="h-px bg-border my-6"></div>

                <div class="p-4 bg-surface rounded-xl text-sm">
                    <div class="font-bold mb-2">Information</div>
                    <div class="text-muted space-y-1 text-xs">
                        <p>Version 3.0.0 (OLED Edition)</p>
                        <p class="flex items-center gap-1">
                            Icons by <a href="https://icons8.com" target="_blank" class="underline hover:text-text">Icons8</a> & Lucide
                        </p>
                    </div>
                </div>

                <button onclick="app.logout()" class="w-full py-4 text-danger font-bold text-sm hover:bg-red-500/10 rounded-xl transition-colors">
                    Log Out
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL ERROR HANDLER ---
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('errorOverlay').style.display = 'flex';
            document.getElementById('errorText').innerText = `${msg}\nLine: ${line}`;
            return false;
        };

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyDuP_aYZpqJ-Y8LINCIywCFw3G2ZYVExv4",
          authDomain: "msgr-minimum.firebaseapp.com",
          projectId: "msgr-minimum",
          storageBucket: "msgr-minimum.firebasestorage.app",
          messagingSenderId: "583321384135",
          appId: "1:583321384135:web:2b9f7cae0f37419341fae2"
        };

        // --- APP CONTROLLER ---
        const app = {
            db: null,
            auth: null,
            user: null,
            activeChat: null,
            theme: localStorage.getItem('theme') || 'dark',
            unsubscribeMsg: null,
            editingId: null,
            mediaRecorder: null,
            chunks: [],

            init: function() {
                try {
                    // Init Theme First
                    document.documentElement.setAttribute('data-theme', this.theme);
                    this.updateLogos();

                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    this.auth = firebase.auth();
                    this.db = firebase.firestore();

                    // Persistence
                    this.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

                    // Auth Listener
                    this.auth.onAuthStateChanged(user => {
                        const boot = document.getElementById('bootScreen');
                        if (user) {
                            this.user = user;
                            this.loadUser();
                        } else {
                            boot.classList.add('opacity-0', 'pointer-events-none');
                            this.showAuth();
                        }
                    });

                    this.setupUI();
                } catch (e) {
                    console.error("Init Error:", e);
                    alert("App Init Failed: " + e.message);
                }
            },

            updateLogos: function() {
                const src = this.theme === 'dark' ? 'logo_w_nobg.png' : 'logo_b_nobg.png';
                ['bootLogo', 'authLogo'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.src = src;
                });
                const icon = this.theme === 'dark' ? 'sun' : 'moon';
                document.getElementById('iconTheme').setAttribute('data-lucide', icon);
                lucide.createIcons();
            },

            loadUser: async function() {
                // Remove Boot Screen
                document.getElementById('bootScreen').classList.add('opacity-0', 'pointer-events-none');
                
                try {
                    let doc = await this.db.collection('users').doc(this.user.uid).get();
                    
                    // Create if not exists
                    if (!doc.exists) {
                        const username = 'user' + Math.floor(Math.random() * 100000);
                        await this.db.collection('users').doc(this.user.uid).set({
                            displayName: this.user.displayName || 'User',
                            email: this.user.email,
                            photoURL: this.user.photoURL,
                            username: username,
                            uid: this.user.uid
                        });
                        doc = await this.db.collection('users').doc(this.user.uid).get();
                    }

                    const data = doc.data();
                    this.renderProfile(data);
                    this.showApp();
                    this.loadChats();
                } catch(e) {
                    console.error(e);
                    // If rules block access, this catches it
                }
            },

            renderProfile: function(data) {
                const defImg = this.theme === 'dark' ? 'logo_w_nobg.png' : 'logo_b_nobg.png';
                const img = data.photoURL || defImg;
                
                document.getElementById('myAvatar').src = img;
                document.getElementById('myNameDisplay').innerText = data.displayName;
                document.getElementById('settingsAvatar').src = img;
                document.getElementById('settingsName').innerText = data.displayName;
                document.getElementById('settingsUsername').innerText = '@' + data.username;
                
                document.getElementById('editName').value = data.displayName;
                document.getElementById('editUsername').value = data.username;
            },

            showApp: function() {
                document.getElementById('viewAuth').classList.add('hidden');
                const v = document.getElementById('viewApp');
                v.classList.remove('hidden');
                setTimeout(() => v.classList.remove('opacity-0'), 50);
            },
            
            showAuth: function() {
                document.getElementById('viewApp').classList.add('hidden');
                const v = document.getElementById('viewAuth');
                v.classList.remove('hidden');
                setTimeout(() => v.classList.remove('opacity-0'), 50);
            },

            loadChats: function() {
                this.db.collection('chats')
                    .where('participants', 'array-contains', this.user.uid)
                    .onSnapshot(snap => {
                        const list = document.getElementById('chatList');
                        const chats = [];
                        snap.forEach(doc => chats.push({ id: doc.id, ...doc.data() }));
                        
                        // Sort by time
                        chats.sort((a,b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                        
                        list.innerHTML = '';
                        chats.forEach(async chat => {
                            if(chat.deletedBy && chat.deletedBy.includes(this.user.uid)) return;

                            const otherId = chat.participants.find(u => u !== this.user.uid);
                            // Simple fetch (In prod, use cache)
                            const uSnap = await this.db.collection('users').doc(otherId).get();
                            const u = uSnap.data() || { displayName: 'Unknown', photoURL: null };
                            
                            const defImg = this.theme === 'dark' ? 'logo_w_nobg.png' : 'logo_b_nobg.png';
                            
                            const div = document.createElement('div');
                            const isActive = this.activeChat === chat.id;
                            div.className = `p-3 mx-1 rounded-xl flex items-center gap-3 cursor-pointer transition-colors ${isActive ? 'bg-surface' : 'hover:bg-surface/50'}`;
                            
                            // Time
                            let timeStr = "";
                            if(chat.lastMessageTime) {
                                const d = new Date(chat.lastMessageTime);
                                timeStr = `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                            }

                            div.innerHTML = `
                                <img src="${u.photoURL || defImg}" class="w-12 h-12 rounded-full bg-border object-cover">
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-baseline mb-0.5">
                                        <h4 class="font-medium text-sm truncate ${isActive ? 'text-accent' : ''}">${u.displayName}</h4>
                                        <span class="text-[10px] text-muted font-mono">${timeStr}</span>
                                    </div>
                                    <p class="text-[13px] text-muted truncate opacity-80">
                                        ${chat.lastSenderId === this.user.uid ? '<span class="text-text">You:</span> ' : ''}
                                        ${chat.lastMessage || 'Начните общение'}
                                    </p>
                                </div>
                            `;
                            div.onclick = () => this.openChat(chat.id, u);
                            list.appendChild(div);
                        });
                    });
            },

            openChat: function(chatId, user) {
                this.activeChat = chatId;
                
                // UI Mobile Switch
                const sidebar = document.getElementById('sidebar');
                const chatInterface = document.getElementById('chatInterface');
                
                if (window.innerWidth < 768) {
                    sidebar.style.transform = 'translateX(-100%)';
                    chatInterface.style.transform = 'translateX(0)';
                }
                document.getElementById('emptyState').classList.add('hidden'); // Hide desktop empty state

                // Set Header
                const defImg = this.theme === 'dark' ? 'logo_w_nobg.png' : 'logo_b_nobg.png';
                document.getElementById('chatName').innerText = user.displayName;
                document.getElementById('chatAvatar').src = user.photoURL || defImg;

                // Load Messages
                if (this.unsubscribeMsg) this.unsubscribeMsg();
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                this.unsubscribeMsg = this.db.collection('chats').doc(chatId).collection('messages')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot(snap => {
                        container.innerHTML = '';
                        snap.forEach(doc => {
                            const msg = doc.data();
                            if(msg.deletedFor && msg.deletedFor.includes(this.user.uid)) return;

                            const isOwn = msg.senderId === this.user.uid;
                            
                            const wrap = document.createElement('div');
                            wrap.className = `flex w-full ${isOwn ? 'justify-end' : 'justify-start'} animate-fade-in group relative`;
                            
                            // Context Menu Button (Desktop: Hover, Mobile: Long press logic simplified)
                            let actions = '';
                            if (isOwn) {
                                actions = `
                                    <div class="absolute top-0 ${isOwn ? '-left-8' : '-right-8'} opacity-0 group-hover:opacity-100 transition-opacity flex flex-col gap-1">
                                        <button onclick="app.startEdit('${doc.id}', '${msg.text.replace(/'/g, "\\'")}', '${msg.type}')" class="p-1 text-muted hover:text-text"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                        <button onclick="app.deleteMessage('${doc.id}')" class="p-1 text-muted hover:text-danger"><i data-lucide="trash" class="w-3 h-3"></i></button>
                                    </div>
                                `;
                            }

                            // Content Rendering
                            let contentHtml = '';
                            if (msg.type === 'text') {
                                contentHtml = `<span class="whitespace-pre-wrap">${msg.text}</span>`;
                            } else if (msg.type === 'image') {
                                contentHtml = `<img src="${msg.content}" class="rounded-lg max-w-full md:max-w-xs cursor-pointer" onclick="window.open(this.src)">`;
                            } else if (msg.type === 'audio') {
                                contentHtml = `
                                    <div class="flex items-center gap-3 min-w-[140px]">
                                        <button class="w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center hover:bg-accent/40" onclick="new Audio('${msg.content}').play()">
                                            <i data-lucide="play" class="w-3 h-3 text-accent fill-current"></i>
                                        </button>
                                        <div class="waveform flex-1">
                                            ${Array(12).fill(0).map(()=>`<div class="bar" style="height: ${Math.random()*100}%"></div>`).join('')}
                                        </div>
                                    </div>
                                `;
                            }

                            // Timestamp
                            const d = new Date(msg.timestamp);
                            const tStr = `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;

                            wrap.innerHTML = `
                                ${actions}
                                <div class="msg-bubble ${isOwn ? 'msg-own' : 'msg-other'} shadow-sm">
                                    ${contentHtml}
                                    <div class="text-[9px] text-right opacity-60 mt-1 flex justify-end gap-1 items-center">
                                        ${msg.edited ? '<span>(ред.)</span>' : ''}
                                        ${tStr}
                                        ${isOwn ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''}
                                    </div>
                                </div>
                            `;
                            container.appendChild(wrap);
                        });
                        lucide.createIcons();
                        container.scrollTop = container.scrollHeight;
                    });
            },

            closeChat: function() {
                this.activeChat = null;
                const sidebar = document.getElementById('sidebar');
                const chatInterface = document.getElementById('chatInterface');
                
                if (window.innerWidth < 768) {
                    sidebar.style.transform = 'translateX(0)';
                    chatInterface.style.transform = 'translateX(100%)';
                }
            },

            // --- MESSAGING ---
            sendMessage: async function(type = 'text', content = null) {
                if (!this.activeChat) return;
                
                const input = document.getElementById('msgInput');
                const text = input.value.trim();

                if (this.editingId) {
                    this.finishEdit(text);
                    return;
                }

                if (type === 'text' && !text) return;

                // Reset Input
                input.value = '';
                this.checkInput();
                
                const msg = {
                    text: type === 'text' ? text : (type === 'image' ? 'Фото' : 'Аудио'),
                    type: type,
                    content: content, // base64
                    senderId: this.user.uid,
                    timestamp: Date.now()
                };

                try {
                    await this.db.collection('chats').doc(this.activeChat).collection('messages').add(msg);
                    await this.db.collection('chats').doc(this.activeChat).update({
                        lastMessage: msg.text,
                        lastMessageTime: Date.now(),
                        lastSenderId: this.user.uid
                    });
                } catch(e) {
                    console.error(e);
                    alert("Ошибка отправки. Проверьте правила доступа.");
                }
            },

            // --- EDIT / DELETE MSG ---
            startEdit: function(id, text, type) {
                if (type !== 'text') return;
                this.editingId = id;
                const input = document.getElementById('msgInput');
                input.value = text;
                input.focus();
                document.getElementById('editIndicator').classList.remove('hidden');
                document.getElementById('editIndicator').classList.add('flex');
            },

            cancelEdit: function() {
                this.editingId = null;
                document.getElementById('msgInput').value = '';
                document.getElementById('editIndicator').classList.add('hidden');
                document.getElementById('editIndicator').classList.remove('flex');
                this.checkInput();
            },

            finishEdit: async function(text) {
                if (!text) return;
                await this.db.collection('chats').doc(this.activeChat).collection('messages').doc(this.editingId).update({
                    text: text,
                    edited: true
                });
                this.cancelEdit();
            },

            deleteMessage: async function(id) {
                if(confirm("Удалить сообщение у всех?")) {
                    await this.db.collection('chats').doc(this.activeChat).collection('messages').doc(id).delete();
                }
            },

            // --- FILE & AUDIO ---
            handleFileUpload: function(input) {
                const file = input.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Simple compression/resize check would go here
                    this.sendMessage('image', e.target.result);
                };
                reader.readAsDataURL(file);
            },

            toggleRecording: async function() {
                if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                    this.mediaRecorder.stop();
                    document.getElementById('btnMic').classList.remove('text-red-500', 'animate-pulse');
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.chunks = [];
                    
                    document.getElementById('btnMic').classList.add('text-red-500', 'animate-pulse');

                    this.mediaRecorder.ondataavailable = e => this.chunks.push(e.data);
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.chunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            this.sendMessage('audio', reader.result);
                        }
                    };
                    this.mediaRecorder.start();
                } catch(e) {
                    alert("Нужен доступ к микрофону");
                }
            },

            // --- CHAT ACTIONS ---
            toggleChatMenu: () => {
                const m = document.getElementById('chatMenu');
                m.classList.toggle('hidden');
                m.classList.toggle('flex');
            },
            hideChatMenu: () => document.getElementById('chatMenu').classList.add('hidden'),

            clearChat: async function(everyone) {
                if(!confirm("Вы уверены?")) return;
                const batch = this.db.batch();
                const q = await this.db.collection('chats').doc(this.activeChat).collection('messages').get();
                
                if (everyone) {
                    q.forEach(doc => batch.delete(doc.ref));
                } else {
                    // Soft delete simulation
                    // In real app, write to subcollection 'deletedMessages'
                    alert("Локальная очистка (Демо)");
                }
                await batch.commit();
                this.hideChatMenu();
            },

            blockUser: function() {
                alert("Пользователь заблокирован");
                this.hideChatMenu();
                this.closeChat();
            },

            deleteChat: async function() {
                if(!confirm("Удалить чат навсегда?")) return;
                await this.db.collection('chats').doc(this.activeChat).delete();
                this.activeChat = null;
                this.closeChat();
            },

            // --- THEME ---
            toggleTheme: function() {
                this.theme = this.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', this.theme);
                document.documentElement.setAttribute('data-theme', this.theme);
                this.updateLogos();
                
                // Reload profile avatars if they are defaults
                if(this.user) this.loadUser(); 
            },

            // --- HELPERS ---
            checkInput: function() {
                const val = document.getElementById('msgInput').value.trim();
                const hasText = val.length > 0;
                document.getElementById('btnMic').classList.toggle('hidden', hasText);
                document.getElementById('btnSend').classList.toggle('hidden', !hasText);
                
                const el = document.getElementById('msgInput');
                el.style.height = 'auto';
                el.style.height = el.scrollHeight + 'px';
            },

            openSearch: () => {
                document.getElementById('modalSearch').classList.remove('hidden');
                document.getElementById('userSearchInput').focus();
            },
            closeSearch: () => document.getElementById('modalSearch').classList.add('hidden'),
            
            openSettings: () => {
                const m = document.getElementById('modalSettings');
                m.classList.remove('hidden');
                setTimeout(() => m.classList.remove('translate-y-full'), 10);
            },
            closeSettings: () => {
                const m = document.getElementById('modalSettings');
                m.classList.add('translate-y-full');
                setTimeout(() => m.classList.add('hidden'), 300);
            },
            logout: () => firebase.auth().signOut().then(() => location.reload()),
            
            saveProfile: async function() {
                const name = document.getElementById('editName').value;
                const user = document.getElementById('editUsername').value;
                await this.db.collection('users').doc(this.user.uid).update({
                    displayName: name,
                    username: user
                });
                alert("Сохранено");
                this.closeSettings();
                this.loadUser();
            },
            
            updateAvatar: function(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await this.db.collection('users').doc(this.user.uid).update({ photoURL: e.target.result });
                    document.getElementById('settingsAvatar').src = e.target.result;
                    this.loadUser();
                }
                reader.readAsDataURL(file);
            }
        };

        // UI Event Listeners
        document.getElementById('msgInput').addEventListener('input', () => app.checkInput());
        document.getElementById('msgInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); app.sendMessage(); }
        });

        // Search Logic
        document.getElementById('userSearchInput').addEventListener('input', debounce(async (e) => {
            const term = e.target.value.toLowerCase().replace('@','');
            const div = document.getElementById('searchResults');
            if(term.length < 3) return;

            const snap = await app.db.collection('users')
                .where('username', '>=', term)
                .where('username', '<=', term + '\uf8ff')
                .limit(5).get();

            div.innerHTML = '';
            snap.forEach(doc => {
                if(doc.id === app.user.uid) return;
                const u = doc.data();
                const el = document.createElement('div');
                el.className = 'flex items-center gap-3 p-2 hover:bg-surface rounded-lg cursor-pointer transition-colors';
                const defImg = app.theme === 'dark' ? 'logo_w_nobg.png' : 'logo_b_nobg.png';
                el.innerHTML = `
                    <img src="${u.photoURL || defImg}" class="w-10 h-10 rounded-full bg-border object-cover">
                    <div>
                        <div class="font-medium text-sm">${u.displayName}</div>
                        <div class="text-xs text-muted">@${u.username}</div>
                    </div>
                `;
                el.onclick = async () => {
                    // Create Chat Logic with Strict Rules
                    const exist = await app.db.collection('chats').where('participants', 'array-contains', app.user.uid).get();
                    let found = null;
                    exist.forEach(d => { if(d.data().participants.includes(doc.id)) found = d.id; });

                    if(found) {
                        app.openChat(found, u);
                    } else {
                        const ref = await app.db.collection('chats').add({
                            participants: [app.user.uid, doc.id],
                            createdAt: Date.now()
                        });
                        app.openChat(ref.id, u);
                    }
                    app.closeSearch();
                };
                div.appendChild(el);
            });
        }, 500));

        // Filter Chats
        document.getElementById('filterChatInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const items = document.getElementById('chatList').children;
            Array.from(items).forEach(item => {
                const name = item.innerText.toLowerCase();
                item.style.display = name.includes(val) ? 'flex' : 'none';
            });
        });

        document.getElementById('btnGoogle').onclick = () => app.auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- START ---
        app.init();
    </script>
</body>
</html>
