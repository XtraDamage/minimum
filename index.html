<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>minimum</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Lucide & Google) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs (Compat for easier prototyping) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        bg: 'var(--bg)',
                        surface: 'var(--surface)',
                        'surface-hover': 'var(--surface-hover)',
                        border: 'var(--border)',
                        text: 'var(--text)',
                        'text-muted': 'var(--text-muted)',
                        accent: 'var(--accent)',
                        'accent-fg': 'var(--accent-fg)',
                        danger: '#ef4444',
                        'msg-own-bg': 'var(--msg-own-bg)',
                        'msg-own-text': 'var(--msg-own-text)',
                        'msg-other-bg': 'var(--msg-other-bg)',
                        'msg-other-text': 'var(--msg-other-text)',
                    },
                    animation: {
                        'enter': 'enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-in': 'slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        enter: { 
                            '0%': { opacity: '0', transform: 'scale(0.96) translateY(10px)' }, 
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' } 
                        },
                        slideIn: { 
                            '0%': { transform: 'translateX(20px)', opacity: '0' }, 
                            '100%': { transform: 'translateX(0)', opacity: '1' } 
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&display=swap');

        /* THEMES */
        :root[data-theme="dark"] {
            --bg: #000000;
            --surface: #121212;
            --surface-hover: #1E1E1E;
            --border: #262626;
            --text: #ffffff;
            --text-muted: #888888;
            --accent: #ffffff;
            --accent-fg: #000000;
            --msg-own-bg: #2d2d2d;
            --msg-own-text: #ffffff;
            --msg-other-bg: #121212;
            --msg-other-text: #ffffff;
        }

        :root[data-theme="light"] {
            --bg: #ffffff;
            --surface: #f4f4f5;
            --surface-hover: #e4e4e7;
            --border: #e4e4e7;
            --text: #09090b;
            --text-muted: #71717a;
            --accent: #000000;
            --accent-fg: #ffffff;
            --msg-own-bg: #000000;
            --msg-own-text: #ffffff;
            --msg-other-bg: #f4f4f5;
            --msg-other-text: #000000;
        }

        :root[data-theme="oled"] {
            --bg: #000000;
            --surface: #000000;
            --surface-hover: #111111;
            --border: #333333;
            --text: #e5e5e5;
            --text-muted: #666666;
            --accent: #3b82f6;
            --accent-fg: #ffffff;
            --msg-own-bg: #3b82f6;
            --msg-own-text: #ffffff;
            --msg-other-bg: #1a1a1a;
            --msg-other-text: #e5e5e5;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            height: 100dvh; 
            width: 100vw;
        }

        /* UTILS */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .input-minimal {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            border-radius: 0;
            transition: border-color 0.2s;
        }
        .input-minimal:focus {
            outline: none;
            border-bottom-color: var(--accent);
        }

        /* MESSAGES */
        .msg-bubble {
            max-width: 80%;
            padding: 10px 14px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg-own {
            background: var(--msg-own-bg);
            color: var(--msg-own-text);
            border-radius: 18px 18px 4px 18px;
        }
        .msg-other {
            background: var(--msg-other-bg);
            color: var(--msg-other-text);
            border-radius: 18px 18px 18px 4px;
        }

        /* ELEMENTS */
        .btn-icon {
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s;
            color: var(--text-muted);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:hover {
            background: var(--surface-hover);
            color: var(--text);
        }
        .btn-icon:active { transform: scale(0.92); }

        .logo-small {
            height: 24px;
            width: auto;
            object-fit: contain;
            filter: grayscale(100%);
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .group:hover .logo-small { opacity: 1; filter: none; }

        /* TOGGLE SWITCH */
        .toggle-checkbox:checked {
            right: 0;
            border-color: var(--accent);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--accent);
        }
    </style>
</head>
<body class="flex flex-col h-full font-sans antialiased selection:bg-accent selection:text-accent-fg">

    <!-- SPLASH SCREEN -->
    <div id="splash" class="fixed inset-0 z-[100] bg-bg flex items-center justify-center transition-opacity duration-700">
        <img id="splashLogo" src="logo_w_nobg.png" class="w-24 h-24 object-contain animate-pulse-slow">
    </div>

    <!-- AUTH SCREEN -->
    <div id="viewAuth" class="fixed inset-0 z-50 bg-bg flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-500">
        <div class="w-full max-w-sm p-8 flex flex-col items-center animate-enter">
            <img id="authLogo" src="logo_w_nobg.png" class="w-40 h-40 object-contain mb-8">
            
            <h1 class="text-4xl font-light mb-2 tracking-tighter">minimum</h1>
            <p class="text-text-muted text-xs mb-12 font-mono tracking-widest uppercase">Identity System v2.1</p>
            
            <button id="btnGoogle" class="group relative w-full h-14 bg-surface hover:bg-surface-hover border border-border rounded-xl flex items-center justify-center gap-4 transition-all active:scale-[0.98]">
                <img src="https://img.icons8.com/color/48/google-logo.png" class="w-6 h-6" alt="Google">
                <span class="font-medium text-lg">Войти через Google</span>
            </button>
            <p class="mt-8 text-[10px] text-text-muted text-center max-w-[200px] leading-relaxed">
                Используя вход, вы принимаете политику конфиденциальности Minimum ID.
            </p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="viewApp" class="flex-1 flex overflow-hidden relative opacity-0 transition-opacity duration-500">
        
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-full md:w-[400px] bg-bg border-r border-border flex flex-col h-full z-10 transition-transform duration-300 absolute md:relative">
            
            <!-- Header -->
            <div class="h-16 px-4 flex items-center justify-between border-b border-border bg-bg/95 backdrop-blur sticky top-0 z-20">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="openSettings()">
                    <div class="relative">
                        <img id="myAvatar" class="w-9 h-9 rounded-full bg-surface object-cover border border-border group-hover:border-accent transition-colors">
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-bg"></div>
                    </div>
                    <img id="headerLogo" src="logo_w_nobg.png" class="logo-small hidden md:block">
                </div>
                <div class="flex gap-1 items-center">
                    <img src="logo_w_nobg.png" class="w-6 h-6 object-contain md:hidden opacity-50 mr-2"> <!-- Mobile Logo -->
                    <button class="btn-icon" id="btnNewChat"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                </div>
            </div>

            <!-- Search -->
            <div class="px-4 py-3">
                <div class="h-11 bg-surface rounded-xl flex items-center px-4 gap-3 focus-within:ring-1 focus-within:ring-accent transition-all">
                    <i data-lucide="search" class="w-4 h-4 text-text-muted"></i>
                    <input id="chatSearch" type="text" placeholder="Поиск..." class="bg-transparent border-none outline-none text-sm w-full placeholder-text-muted h-full">
                </div>
            </div>

            <!-- Chat List -->
            <div id="chatList" class="flex-1 overflow-y-auto no-scrollbar pb-20 space-y-1 p-2">
                <!-- Chats injected here -->
            </div>
        </div>

        <!-- CHAT VIEW -->
        <div id="chatView" class="absolute inset-0 z-20 bg-bg flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300 md:static md:flex-1 md:!transform-none">
            
            <!-- Chat Header -->
            <div id="chatHeader" class="h-16 px-4 border-b border-border flex items-center justify-between bg-bg/95 backdrop-blur z-20">
                <div class="flex items-center gap-3">
                    <button id="btnBack" class="md:hidden btn-icon -ml-2"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                    <div class="relative">
                        <img id="chatAvatar" class="w-9 h-9 rounded-full bg-surface object-cover">
                    </div>
                    <div class="flex flex-col">
                        <span id="chatName" class="font-medium text-sm leading-tight">Name</span>
                        <span id="chatStatus" class="text-[10px] text-text-muted uppercase tracking-wider font-medium">offline</span>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button class="btn-icon" id="btnChatMenu"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar bg-bg relative">
                <!-- Messages injected here -->
            </div>

            <!-- Edit Indicator -->
            <div id="editBar" class="hidden px-4 py-2 bg-surface text-xs flex justify-between items-center border-t border-border animate-slide-in">
                <span class="text-accent flex items-center gap-2"><i data-lucide="pencil" class="w-3 h-3"></i> Редактирование</span>
                <button id="btnCancelEdit" class="text-text-muted hover:text-text"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <!-- Input Area -->
            <div class="p-3 md:p-4 bg-bg border-t border-border">
                <div class="flex items-end gap-2 bg-surface p-2 rounded-2xl border border-border transition-colors hover:border-text-muted/30 focus-within:border-accent">
                    <button id="btnAttach" class="p-2.5 text-text-muted hover:text-text transition-colors rounded-xl hover:bg-bg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    <input type="file" id="fileInput" class="hidden" accept="image/*,video/*">
                    
                    <textarea id="msgInput" rows="1" placeholder="Сообщение..." class="flex-1 bg-transparent border-none outline-none text-[15px] py-2.5 max-h-32 resize-none placeholder-text-muted" style="min-height: 24px;"></textarea>
                    
                    <button id="btnSend" class="p-2.5 bg-accent text-accent-fg rounded-xl transition-all active:scale-90 hover:opacity-90 shadow-lg shadow-accent/20"><i data-lucide="arrow-up" class="w-5 h-5"></i></button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none md:hidden bg-bg z-0">
                <img src="logo_w_nobg.png" id="emptyLogo" class="w-16 h-16 opacity-10 mb-4">
                <span class="text-text-muted text-sm font-mono opacity-50">NO CHAT SELECTED</span>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Chat Options Menu -->
    <div id="chatMenuModal" class="fixed inset-0 z-50 hidden" onclick="this.classList.add('hidden')">
        <div class="absolute right-4 top-16 md:right-6 bg-surface border border-border rounded-xl shadow-2xl w-56 overflow-hidden py-1 animate-enter origin-top-right" onclick="event.stopPropagation()">
            <div class="px-4 py-2 border-b border-border mb-1">
                <span class="text-[10px] text-text-muted font-mono uppercase tracking-widest">Действия</span>
            </div>
            <button onclick="app.clearChat(false)" class="w-full text-left px-4 py-2.5 text-sm hover:bg-surface-hover flex items-center gap-3"><i data-lucide="trash-2" class="w-4 h-4"></i> Очистить у меня</button>
            <button onclick="app.clearChat(true)" class="w-full text-left px-4 py-2.5 text-sm hover:bg-surface-hover flex items-center gap-3"><i data-lucide="trash" class="w-4 h-4"></i> Очистить у всех</button>
            <div class="h-px bg-border my-1"></div>
            <button onclick="app.deleteChat()" class="w-full text-left px-4 py-2.5 text-sm text-danger hover:bg-danger/10 flex items-center gap-3"><i data-lucide="x-circle" class="w-4 h-4"></i> Удалить чат</button>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="searchModal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-start justify-center pt-24 opacity-0 transition-opacity duration-200" onclick="if(event.target === this) closeSearch()">
        <div class="w-full max-w-md bg-bg border border-border rounded-2xl shadow-2xl overflow-hidden mx-4 transform transition-all scale-95 duration-200" id="searchModalContent">
            <div class="flex items-center border-b border-border p-4 gap-3">
                <i data-lucide="user-plus" class="w-5 h-5 text-text-muted"></i>
                <input id="userSearchInput" class="flex-1 bg-transparent outline-none h-full text-base placeholder-text-muted" placeholder="Поиск пользователя (@username)...">
                <button onclick="closeSearch()" class="p-1 hover:bg-surface rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="searchResults" class="min-h-[100px] max-h-[300px] overflow-y-auto p-2"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 bg-bg flex flex-col hidden transition-transform duration-300 transform translate-y-full">
        <div class="h-16 px-4 flex items-center justify-between border-b border-border sticky top-0 bg-bg/95 backdrop-blur z-10">
            <h2 class="font-medium text-lg flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5"></i> Настройки
            </h2>
            <button onclick="closeSettings()" class="btn-icon bg-surface"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 max-w-2xl mx-auto w-full space-y-8 pb-20">
            
            <!-- Profile Card -->
            <div class="flex flex-col items-center">
                <div class="relative w-28 h-28 mb-4 group cursor-pointer">
                    <img id="settingsAvatar" class="w-full h-full rounded-full object-cover border-4 border-surface shadow-xl">
                    <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm">
                        <i data-lucide="camera" class="w-8 h-8 text-white"></i>
                    </div>
                    <input type="file" id="avatarUpload" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*">
                </div>
                <div class="text-center w-full">
                    <input id="editName" type="text" class="text-2xl font-semibold bg-transparent text-center outline-none border-b border-transparent focus:border-accent w-full placeholder-text-muted" placeholder="Ваше имя">
                    <div class="flex items-center justify-center gap-1 mt-1 text-text-muted">
                        <span class="opacity-50">@</span>
                        <input id="editUsername" type="text" class="text-sm font-mono bg-transparent outline-none border-b border-transparent focus:border-accent w-[150px] text-center" placeholder="username">
                    </div>
                </div>
            </div>

            <!-- Appearance -->
            <div class="space-y-4">
                <h3 class="text-xs font-mono uppercase tracking-widest text-text-muted ml-1">Внешний вид</h3>
                <div class="bg-surface rounded-2xl p-4 space-y-4 border border-border">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">Тема оформления</span>
                        <select id="themeSelector" class="bg-bg border border-border rounded-lg text-sm px-3 py-1.5 outline-none focus:border-accent" onchange="app.setTheme(this.value)">
                            <option value="dark">Тёмная (Default)</option>
                            <option value="light">Светлая</option>
                            <option value="oled">OLED (Черная)</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">Язык</span>
                        <select id="langSelector" class="bg-bg border border-border rounded-lg text-sm px-3 py-1.5 outline-none focus:border-accent">
                            <option value="ru">Русский</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Privacy -->
            <div class="space-y-4">
                <h3 class="text-xs font-mono uppercase tracking-widest text-text-muted ml-1">Приватность</h3>
                <div class="bg-surface rounded-2xl p-4 space-y-4 border border-border">
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium">Показывать статус "В сети"</span>
                            <span class="text-xs text-text-muted">Другие пользователи видят когда вы онлайн</span>
                        </div>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="onlineStatusToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-border checked:border-accent transition-all duration-300" checked/>
                            <label for="onlineStatusToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-bg cursor-pointer border border-border"></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About -->
            <div class="pt-4 border-t border-border">
                <div class="flex items-center justify-between py-3 cursor-pointer group" onclick="toggleAbout()">
                    <span class="font-medium text-sm group-hover:text-accent transition-colors">О приложении</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-text-muted group-hover:translate-x-1 transition-transform"></i>
                </div>
                <div id="aboutSection" class="hidden text-sm text-text-muted mt-2 p-4 bg-surface rounded-xl border border-border">
                    <div class="flex items-center gap-3 mb-4">
                        <img src="logo_w_nobg.png" id="aboutLogo" class="w-10 h-10 object-contain">
                        <div>
                            <p class="font-bold text-text">Minimum Messenger</p>
                            <p class="text-xs font-mono opacity-70">Build 2.4.0 (Stable)</p>
                        </div>
                    </div>
                    <p class="mb-4 text-xs leading-relaxed opacity-80">
                        Простой, быстрый и красивый мессенджер. 
                        Разработано с вниманием к деталям.
                    </p>
                    <hr class="border-border my-2">
                    <div class="flex gap-4 mt-2">
                        <a href="https://icons8.com" target="_blank" class="text-xs hover:text-accent flex items-center gap-1"><i data-lucide="external-link" class="w-3 h-3"></i> Icons8</a>
                        <a href="#" class="text-xs hover:text-accent">GitHub</a>
                        <a href="#" class="text-xs hover:text-accent">Правила</a>
                    </div>
                </div>
            </div>

            <button onclick="app.logout()" class="w-full py-4 text-danger font-medium text-sm bg-danger/5 hover:bg-danger/10 border border-danger/20 rounded-xl transition-all mt-4">
                Выйти из аккаунта
            </button>
        </div>
        
        <div class="p-4 border-t border-border flex justify-end bg-bg/95 backdrop-blur z-10">
            <button onclick="app.saveProfile()" class="bg-accent text-accent-fg px-8 py-3 rounded-xl font-medium shadow-lg shadow-accent/20 hover:opacity-90 active:scale-95 transition-all">Сохранить</button>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyDuP_aYZpqJ-Y8LINCIywCFw3G2ZYVExv4",
          authDomain: "msgr-minimum.firebaseapp.com",
          projectId: "msgr-minimum",
          storageBucket: "msgr-minimum.firebasestorage.app",
          messagingSenderId: "583321384135",
          appId: "1:583321384135:web:2b9f7cae0f37419341fae2"
        };

        // --- APP LOGIC ---
        const app = {
            db: null,
            auth: null,
            user: null,
            activeChat: null,
            activeChatUser: null,
            listeners: {},
            theme: 'dark',
            editingMsgId: null,

            init: async () => {
                if(typeof firebase === 'undefined') return console.error('Firebase Error');
                try {
                    firebase.initializeApp(firebaseConfig);
                    app.auth = firebase.auth();
                    app.db = firebase.firestore();
                    app.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                } catch(e) { console.error(e); }

                // Load Local Settings
                const savedTheme = localStorage.getItem('theme') || 'dark';
                app.setTheme(savedTheme);
                document.getElementById('themeSelector').value = savedTheme;

                app.auth.onAuthStateChanged(user => {
                    const splash = document.getElementById('splash');
                    splash.style.opacity = '0';
                    setTimeout(() => splash.style.display = 'none', 700);

                    if(user) {
                        app.user = user;
                        app.loadUser();
                    } else {
                        app.showAuth();
                    }
                });

                app.setupUI();
                lucide.createIcons();
            },

            loadUser: async () => {
                try {
                    const docRef = app.db.collection('users').doc(app.user.uid);
                    const doc = await docRef.get();
                    
                    if(!doc.exists) {
                        const username = 'user_' + Math.floor(Math.random()*100000);
                        await docRef.set({
                            displayName: app.user.displayName || 'User',
                            photoURL: app.user.photoURL,
                            username: username,
                            uid: app.user.uid,
                            createdAt: Date.now(),
                            settings: { privacy_online: true, lang: 'ru' }
                        });
                    }
                    
                    const data = doc.data();
                    const photo = data.photoURL || (app.theme === 'light' ? 'logo_b_nobg.png' : 'logo_w_nobg.png');
                    
                    document.getElementById('myAvatar').src = photo;
                    
                    // Preload Settings
                    document.getElementById('settingsAvatar').src = photo;
                    document.getElementById('editName').value = data.displayName || 'User';
                    document.getElementById('editUsername').value = data.username || 'user';
                    if(data.settings?.privacy_online !== undefined) {
                        document.getElementById('onlineStatusToggle').checked = data.settings.privacy_online;
                    }
                    if(data.settings?.lang) {
                        document.getElementById('langSelector').value = data.settings.lang;
                    }

                    document.getElementById('viewAuth').classList.add('hidden');
                    const viewApp = document.getElementById('viewApp');
                    viewApp.classList.remove('hidden');
                    // Small delay for smooth entry
                    requestAnimationFrame(() => viewApp.classList.remove('opacity-0'));

                    app.loadChats();
                } catch (e) {
                    console.error("Load user error", e);
                }
            },

            loadChats: () => {
                if(app.listeners.chats) app.listeners.chats(); // Unsubscribe old
                
                app.listeners.chats = app.db.collection('chats')
                    .where('participants', 'array-contains', app.user.uid)
                    .orderBy('lastMessageTime', 'desc')
                    .onSnapshot(snap => {
                        const list = document.getElementById('chatList');
                        list.innerHTML = '';
                        
                        if(snap.empty) {
                             list.innerHTML = `<div class="text-center mt-10 text-text-muted text-sm opacity-50">Нет чатов.<br>Начните новый!</div>`;
                             return;
                        }

                        snap.forEach(async doc => {
                            const chat = doc.data();
                            if(chat.deletedBy && chat.deletedBy.includes(app.user.uid)) return;

                            const otherId = chat.participants.find(uid => uid !== app.user.uid);
                            // Optimistic UI for rendering, fetch real user data async
                            // In prod, use a user cache service
                            let otherUser = { displayName: 'Загрузка...', photoURL: null };
                            
                            try {
                                const uDoc = await app.db.collection('users').doc(otherId).get();
                                if(uDoc.exists) otherUser = uDoc.data();
                            } catch(e){}

                            const div = document.createElement('div');
                            const isActive = app.activeChat === doc.id;
                            div.className = `p-3 rounded-xl flex items-center gap-3 cursor-pointer transition-all duration-200 border border-transparent ${isActive ? 'bg-surface border-border shadow-sm' : 'hover:bg-surface/50'}`;
                            
                            const t = chat.lastMessageTime ? new Date(chat.lastMessageTime) : new Date();
                            const timeStr = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
                            
                            // Last message preview logic
                            let preview = 'Нет сообщений';
                            if(chat.lastMessage) {
                                if(chat.lastMessage.startsWith('data:image')) preview = '<span class="flex items-center gap-1"><i data-lucide="image" class="w-3 h-3"></i> Фото</span>';
                                else if(chat.lastMessage.startsWith('data:video')) preview = '<span class="flex items-center gap-1"><i data-lucide="video" class="w-3 h-3"></i> Видео</span>';
                                else preview = chat.lastMessage;
                            }
                            if(chat.lastSenderId === app.user.uid) preview = `<span class="text-accent">Вы:</span> ${preview}`;

                            div.innerHTML = `
                                <div class="relative">
                                    <img src="${otherUser.photoURL || 'logo_w_nobg.png'}" class="w-12 h-12 rounded-full bg-surface object-cover border border-border">
                                    ${isActive ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-accent rounded-full border-2 border-bg"></div>' : ''}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-baseline mb-0.5">
                                        <h4 class="font-medium text-[15px] truncate text-text">${otherUser.displayName}</h4>
                                        <span class="text-[11px] text-text-muted font-mono">${timeStr}</span>
                                    </div>
                                    <div class="text-[13px] text-text-muted truncate leading-tight opacity-90">
                                        ${preview}
                                    </div>
                                </div>
                            `;
                            div.onclick = () => app.openChat(doc.id, otherUser);
                            list.appendChild(div);
                            lucide.createIcons();
                        });
                    });
            },

            openChat: (chatId, user) => {
                app.activeChat = chatId;
                app.activeChatUser = user;
                
                // Mobile Navigation
                const sidebar = document.getElementById('sidebar');
                const chatView = document.getElementById('chatView');
                
                if(window.innerWidth < 768) {
                    sidebar.style.transform = 'translateX(-100%)';
                    chatView.style.transform = 'translateX(0)';
                }

                // UI Updates
                document.getElementById('chatName').innerText = user.displayName;
                document.getElementById('chatAvatar').src = user.photoURL || 'logo_w_nobg.png';
                document.getElementById('chatStatus').innerText = user.settings?.privacy_online ? 'online' : 'was recently';
                document.getElementById('emptyState').classList.add('hidden');
                
                // Refresh Chat List highlights
                app.loadChats();

                // Messages Listener
                if(app.listeners.msgs) app.listeners.msgs();
                const container = document.getElementById('messagesArea');
                container.innerHTML = ''; // loading state

                app.listeners.msgs = app.db.collection('chats').doc(chatId).collection('messages')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot(snap => {
                        container.innerHTML = '';
                        
                        let lastSenderId = null;

                        snap.forEach(doc => {
                            const msg = doc.data();
                            if(msg.deletedFor && msg.deletedFor.includes(app.user.uid)) return;

                            const isOwn = msg.senderId === app.user.uid;
                            const isSequence = lastSenderId === msg.senderId;
                            lastSenderId = msg.senderId;

                            const wrapper = document.createElement('div');
                            wrapper.className = `flex w-full ${isOwn ? 'justify-end' : 'justify-start'} animate-slide-in ${isSequence ? 'mt-1' : 'mt-4'}`;
                            wrapper.id = 'msg-' + doc.id;

                            let content = `<span class="whitespace-pre-wrap">${msg.text}</span>`;
                            
                            // Image Render
                            if(msg.type === 'image') {
                                content = `
                                    <div class="relative group cursor-pointer" onclick="window.open(this.querySelector('img').src)">
                                        <img src="${msg.content}" class="rounded-lg max-w-full md:max-w-[280px] object-cover bg-black/20" onload="app.scrollToBottom()">
                                    </div>`;
                            }
                            // Video Render
                            else if(msg.type === 'video') {
                                content = `
                                    <div class="relative max-w-full md:max-w-[300px] rounded-lg overflow-hidden bg-black">
                                        <video src="${msg.content}" controls class="w-full max-h-[400px]" playsinline></video>
                                    </div>`;
                            }

                            const bubble = document.createElement('div');
                            // Dynamic border radius for sequences
                            let radiusClass = isOwn ? 'rounded-2xl rounded-tr-sm' : 'rounded-2xl rounded-tl-sm';
                            if(isSequence) radiusClass = 'rounded-xl';

                            bubble.className = `msg-bubble ${isOwn ? 'msg-own' : 'msg-other'} ${radiusClass} group flex flex-col`;
                            
                            // Content
                            bubble.innerHTML = content;

                            // Metadata & Edit Button
                            const metaDiv = document.createElement('div');
                            metaDiv.className = `flex items-center gap-1 justify-end mt-1 select-none`;
                            
                            if(isOwn && msg.type === 'text') {
                                const editBtn = document.createElement('button');
                                editBtn.className = 'opacity-0 group-hover:opacity-100 transition-opacity p-0.5 text-current/50 hover:text-current';
                                editBtn.innerHTML = '<i data-lucide="pencil" class="w-3 h-3"></i>';
                                editBtn.onclick = (e) => { e.stopPropagation(); app.startEdit(doc.id, msg.text); };
                                metaDiv.appendChild(editBtn);
                            }

                            const timeSpan = document.createElement('span');
                            timeSpan.className = 'text-[9px] opacity-60 font-mono';
                            const date = new Date(msg.timestamp);
                            timeSpan.innerText = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}${msg.edited ? ' • ред.' : ''}`;
                            
                            metaDiv.appendChild(timeSpan);
                            
                            // Read receipt checkmark (Visual only for demo)
                            if(isOwn) {
                                metaDiv.innerHTML += `<i data-lucide="check" class="w-3 h-3 opacity-60 ml-0.5"></i>`;
                            }

                            bubble.appendChild(metaDiv);
                            wrapper.appendChild(bubble);
                            container.appendChild(wrapper);
                        });
                        app.scrollToBottom();
                        lucide.createIcons();
                    });
            },

            scrollToBottom: () => {
                const c = document.getElementById('messagesArea');
                c.scrollTop = c.scrollHeight;
            },

            sendMessage: async (type = 'text', content = null) => {
                if(!app.activeChat) return;
                
                const input = document.getElementById('msgInput');
                const text = input.value.trim();

                if(type === 'text' && !text) return;
                
                input.value = '';
                input.style.height = 'auto'; // Reset height

                // Loading/Sending indicator could go here

                try {
                    const msgData = {
                        senderId: app.user.uid,
                        timestamp: Date.now(),
                        type: type,
                        text: type === 'text' ? text : (type === 'image' ? 'Фотография' : 'Видео'),
                        content: content || null
                    };

                    const batch = app.db.batch();
                    const msgRef = app.db.collection('chats').doc(app.activeChat).collection('messages').doc();
                    batch.set(msgRef, msgData);

                    const chatRef = app.db.collection('chats').doc(app.activeChat);
                    batch.update(chatRef, {
                        lastMessage: msgData.text,
                        lastMessageTime: Date.now(),
                        lastSenderId: app.user.uid
                    });

                    await batch.commit();
                    app.scrollToBottom();
                } catch(e) {
                    alert('Ошибка отправки: ' + e.message);
                }
            },

            handleFile: (e) => {
                const file = e.target.files[0];
                if(!file) return;

                // 2MB Limit for Base64 safety in Firestore Demo
                if(file.size > 2 * 1024 * 1024) { 
                    alert('Файл слишком большой для демо-версии (Лимит 2MB). В продакшене используйте Firebase Storage.'); 
                    return; 
                }

                const reader = new FileReader();
                reader.onload = (evt) => {
                    let type = 'file';
                    if(file.type.startsWith('image/')) type = 'image';
                    if(file.type.startsWith('video/')) type = 'video';
                    
                    if(type === 'file') { alert('Поддерживаются только фото и видео'); return; }
                    
                    app.sendMessage(type, evt.target.result);
                };
                reader.readAsDataURL(file);
                // Clear input
                e.target.value = '';
            },

            // --- EDITING ---
            startEdit: (msgId, text) => {
                app.editingMsgId = msgId;
                const input = document.getElementById('msgInput');
                input.value = text;
                input.focus();
                document.getElementById('editBar').classList.remove('hidden');
                document.getElementById('btnAttach').classList.add('hidden'); // Hide attach during edit
            },

            cancelEdit: () => {
                app.editingMsgId = null;
                document.getElementById('msgInput').value = '';
                document.getElementById('msgInput').style.height = 'auto';
                document.getElementById('editBar').classList.add('hidden');
                document.getElementById('btnAttach').classList.remove('hidden');
            },

            submitEdit: async () => {
                const text = document.getElementById('msgInput').value.trim();
                if(!text) return app.cancelEdit();
                
                await app.db.collection('chats').doc(app.activeChat).collection('messages').doc(app.editingMsgId).update({
                    text: text,
                    edited: true
                });
                app.cancelEdit();
            },

            // --- HELPERS & ACTIONS ---
            clearChat: async (everyone) => {
                if(!app.activeChat || !confirm('Вы уверены? Это действие нельзя отменить.')) return;
                
                const msgsRef = app.db.collection('chats').doc(app.activeChat).collection('messages');
                const snap = await msgsRef.get();
                
                const batch = app.db.batch();
                snap.forEach(doc => {
                    if(everyone) {
                        batch.delete(doc.ref);
                    } else {
                        batch.delete(doc.ref); // В реальном приложении добавляем в массив deletedFor
                    }
                });
                
                await batch.commit();
                document.getElementById('chatMenuModal').classList.add('hidden');
            },

            deleteChat: async () => {
                if(!confirm('Удалить чат навсегда?')) return;
                await app.db.collection('chats').doc(app.activeChat).delete();
                app.closeChat();
                document.getElementById('chatMenuModal').classList.add('hidden');
            },

            setTheme: (theme) => {
                app.theme = theme;
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                // Dynamic assets
                const logoW = 'logo_w_nobg.png';
                const logoB = 'logo_b_nobg.png';
                const isLight = theme === 'light';
                
                const target = isLight ? logoB : logoW;
                document.getElementById('splashLogo').src = target;
                document.getElementById('authLogo').src = target;
                document.getElementById('headerLogo').src = target;
                document.getElementById('aboutLogo').src = target;
                document.getElementById('emptyLogo').src = target;

                if(app.user) app.loadUser(); // Refresh placeholder avatar
            },

            closeChat: () => {
                app.activeChat = null;
                const sidebar = document.getElementById('sidebar');
                const chatView = document.getElementById('chatView');
                
                if(window.innerWidth < 768) {
                    sidebar.style.transform = 'translateX(0)';
                    chatView.style.transform = 'translateX(100%)';
                }
                setTimeout(() => {
                    document.getElementById('chatName').innerText = '';
                    document.getElementById('emptyState').classList.remove('hidden');
                }, 300);
            },

            showAuth: () => {
                document.getElementById('viewAuth').classList.remove('hidden');
                requestAnimationFrame(() => document.getElementById('viewAuth').classList.remove('opacity-0'));
                document.getElementById('viewApp').classList.add('hidden');
            },

            saveProfile: async () => {
                const name = document.getElementById('editName').value;
                const username = document.getElementById('editUsername').value;
                const isOnline = document.getElementById('onlineStatusToggle').checked;
                const lang = document.getElementById('langSelector').value;

                try {
                    await app.db.collection('users').doc(app.user.uid).update({
                        displayName: name,
                        username: username,
                        'settings.privacy_online': isOnline,
                        'settings.lang': lang
                    });
                    
                    // Avatar upload if changed is handled by onchange event separately below, but could be merged
                    
                    closeSettings();
                    // Show a toast or feedback (Simple alert for now)
                    // alert('Профиль сохранен');
                } catch(e) {
                    alert('Ошибка сохранения');
                }
            },

            logout: () => app.auth.signOut().then(() => location.reload()),

            setupUI: () => {
                document.getElementById('btnGoogle').onclick = () => app.auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
                
                // Auto-resize Textarea
                const input = document.getElementById('msgInput');
                input.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });

                // Send Logic
                input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if(app.editingMsgId) app.submitEdit();
                        else app.sendMessage();
                    }
                });

                document.getElementById('btnSend').onclick = () => {
                    if(app.editingMsgId) app.submitEdit();
                    else app.sendMessage();
                };

                // Navigation
                document.getElementById('btnBack').onclick = app.closeChat;
                document.getElementById('btnChatMenu').onclick = () => document.getElementById('chatMenuModal').classList.remove('hidden');
                document.getElementById('btnCancelEdit').onclick = app.cancelEdit;

                // File Handling
                document.getElementById('btnAttach').onclick = () => document.getElementById('fileInput').click();
                document.getElementById('fileInput').onchange = app.handleFile;

                // Search
                document.getElementById('btnNewChat').onclick = () => {
                    const modal = document.getElementById('searchModal');
                    const content = document.getElementById('searchModalContent');
                    modal.classList.remove('hidden');
                    // Animation
                    requestAnimationFrame(() => {
                        modal.classList.remove('opacity-0');
                        content.classList.remove('scale-95');
                    });
                    document.getElementById('userSearchInput').focus();
                };
                document.getElementById('userSearchInput').oninput = debounce(app.searchUsers, 500);

                // Avatar Upload
                document.getElementById('avatarUpload').onchange = (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        const reader = new FileReader();
                        reader.onload = async (ev) => {
                            await app.db.collection('users').doc(app.user.uid).update({ photoURL: ev.target.result });
                            document.getElementById('settingsAvatar').src = ev.target.result;
                            document.getElementById('myAvatar').src = ev.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                }
            },

            searchUsers: async (e) => {
                const term = e.target.value.toLowerCase().replace('@','');
                const div = document.getElementById('searchResults');
                if(term.length < 3) { div.innerHTML = ''; return; }

                try {
                    // Simple prefix search (In production use Algolia or separate search index)
                    const snap = await app.db.collection('users')
                        .orderBy('username')
                        .startAt(term)
                        .endAt(term + '\uf8ff')
                        .limit(5)
                        .get();

                    div.innerHTML = '';
                    if(snap.empty) div.innerHTML = '<div class="p-4 text-center text-text-muted text-sm">Пользователь не найден</div>';

                    snap.forEach(doc => {
                        const u = doc.data();
                        if(u.uid === app.user.uid) return;
                        const el = document.createElement('div');
                        el.className = 'flex items-center gap-3 p-3 hover:bg-surface rounded-xl cursor-pointer transition-colors';
                        el.innerHTML = `
                            <img src="${u.photoURL || 'logo_w_nobg.png'}" class="w-10 h-10 rounded-full bg-border object-cover">
                            <div>
                                <div class="font-medium text-sm text-text">${u.displayName}</div>
                                <div class="text-xs text-text-muted">@${u.username}</div>
                            </div>
                        `;
                        el.onclick = async () => {
                            // Find existing chat or create new
                            const existSnap = await app.db.collection('chats')
                                .where('participants', 'array-contains', app.user.uid)
                                .get();
                            
                            let foundId = null;
                            existSnap.forEach(d => {
                                const p = d.data().participants;
                                if(p.includes(u.uid) && p.length === 2) foundId = d.id;
                            });
                            
                            if(!foundId) {
                                const ref = await app.db.collection('chats').add({
                                    participants: [app.user.uid, u.uid],
                                    createdAt: Date.now(),
                                    lastMessageTime: Date.now()
                                });
                                foundId = ref.id;
                            }
                            closeSearch();
                            app.openChat(foundId, u);
                        };
                        div.appendChild(el);
                    });
                } catch(err) { console.error(err); }
            }
        };

        // --- GLOBAL UI HELPERS ---
        function openSettings() {
            const m = document.getElementById('settingsModal');
            m.classList.remove('hidden');
            requestAnimationFrame(() => m.classList.remove('translate-y-full'));
        }
        function closeSettings() {
            const m = document.getElementById('settingsModal');
            m.classList.add('translate-y-full');
            setTimeout(() => m.classList.add('hidden'), 300);
        }
        function toggleAbout() {
            const el = document.getElementById('aboutSection');
            el.classList.toggle('hidden');
        }
        function closeSearch() {
            const m = document.getElementById('searchModal');
            m.classList.add('opacity-0');
            document.getElementById('searchModalContent').classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 200);
        }
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Init
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
