<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>minimum // ai</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Libs -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            bg: '#0f0f0f',
                            surface: '#181818',
                            border: '#2a2a2a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(15px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #0f0f0f; 
            color: #e5e5e5; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Glass Effect */
        .glass-panel { 
            background: rgba(24, 24, 24, 0.75); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-header {
            background: rgba(24, 24, 24, 0.85); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Markdown Styles Overrides for "Prose" */
        .prose pre { background: #111 !important; border: 1px solid #333; border-radius: 8px; }
        .prose code { color: #ff7b72; font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.05); padding: 2px 4px; border-radius: 4px; font-weight: 400; }
        .prose pre code { background: transparent; color: inherit; padding: 0; }
        .prose p { margin-bottom: 0.75em; margin-top: 0.75em; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose h1, .prose h2, .prose h3 { color: #fff; font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose blockquote { border-left-color: #333; color: #888; }
        .prose a { color: #3b82f6; text-decoration: none; }
        .prose a:hover { text-decoration: underline; }

        /* File Preview items */
        .preview-item { position: relative; width: 64px; height: 64px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; flex-shrink: 0; background: #222; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-remove { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.8); border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; border: none; z-index: 10; }
        
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body class="h-screen w-screen font-sans selection:bg-white selection:text-black">

    <!-- BACKGROUND -->
    <div class="fixed inset-0 z-0 bg-gradient-to-br from-[#0f0f0f] via-[#121212] to-[#050505]"></div>
    <canvas id="bgCanvas" class="absolute inset-0 z-0 opacity-20 pointer-events-none"></canvas>

    <!-- AUTH VIEW -->
    <div id="viewAuth" class="absolute inset-0 z-50 flex flex-col items-center justify-center transition-all duration-500">
        <div class="flex flex-col items-center animate-slide-up relative z-10">
            <div class="w-24 h-24 bg-white/5 border border-white/10 rounded-3xl flex items-center justify-center shadow-2xl backdrop-blur-md mb-8 ring-1 ring-white/10">
                <i data-lucide="infinity" class="w-12 h-12 text-white"></i>
            </div>
            <h1 class="text-5xl font-extralight tracking-tighter mb-3">minimum</h1>
            <p class="text-gray-500 text-xs tracking-[0.3em] uppercase mb-16 font-semibold">AI Identity System</p>
            
            <button id="btnGoogle" class="group relative overflow-hidden rounded-2xl bg-white text-black px-8 py-4 font-semibold transition-all hover:scale-[1.02] active:scale-[0.98] flex items-center gap-4 shadow-[0_0_40px_rgba(255,255,255,0.1)]">
                <span class="relative z-10 flex items-center gap-2"><svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.8-3.5 5.4-6.5 5.4C8.92 19.23 6 16.05 6 12c0-4.17 3-7.2 7.2-7.2 2.74 0 4.93.99 6.2 2.18l2.7-2.7c-2.4-2.2-5.9-3.4-8.9-3.4C4.8 1 0 5.1 0 12c0 6.9 4.8 11 11.9 11 6.8 0 11.6-4.7 11.6-11.3 0-.8-.1-1.5-.2-2.3z"/></svg> Войти через Google</span>
            </button>
        </div>
    </div>

    <!-- SETUP VIEW -->
    <div id="viewSetup" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-[#0f0f0f] transition-all duration-500 hidden opacity-0">
        <div class="w-full max-w-md p-8 flex flex-col items-center animate-slide-up">
            <h2 class="text-3xl font-medium mb-2 tracking-tight">Профиль</h2>
            <p class="text-gray-500 text-sm mb-12">Ваш уникальный идентификатор</p>
            <div class="w-full relative mb-4">
                <span class="absolute left-0 top-1/2 -translate-y-1/2 text-3xl text-gray-600 font-mono font-light">@</span>
                <input id="inputUsername" type="text" class="w-full bg-transparent border-b-2 border-gray-800 focus:border-white text-center text-3xl py-4 pl-8 font-mono outline-none transition-colors placeholder-gray-800 text-white" placeholder="username" maxlength="12" autocomplete="off" spellcheck="false">
            </div>
            <p id="setupError" class="text-red-500 text-xs font-mono h-4 mb-8 opacity-0 transition-opacity">Error</p>
            <button id="btnFinishSetup" class="w-full bg-white text-black rounded-xl py-4 font-semibold hover:bg-gray-200 transition-colors">Начать</button>
        </div>
    </div>

    <!-- APP VIEW -->
    <div id="viewApp" class="absolute inset-0 z-10 flex opacity-0 pointer-events-none transition-opacity duration-700">
        
        <!-- SIDEBAR -->
        <div id="appSidebar" class="w-full md:w-[350px] lg:w-[400px] h-full glass-panel flex flex-col z-20 absolute md:relative shadow-2xl transition-transform duration-300 transform -translate-x-full md:translate-x-0">
            <!-- Header -->
            <div class="p-4 flex justify-between items-center glass-header border-b-0 bg-transparent">
                <div class="flex items-center gap-3 cursor-pointer p-2 rounded-xl hover:bg-white/5 transition-colors group" id="btnOpenSettings">
                    <div class="relative w-10 h-10">
                        <img id="myAvatar" class="w-full h-full rounded-full object-cover border border-white/10 group-hover:border-white/30 transition-all bg-dark-surface">
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-[#181818]"></div>
                    </div>
                    <div>
                        <div id="myDisplayName" class="text-sm font-semibold leading-tight text-white/90">...</div>
                        <div id="myUsernameDisplay" class="text-xs text-gray-500 font-mono">@...</div>
                    </div>
                </div>
                <button id="btnNewChat" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white text-white hover:text-black flex items-center justify-center transition-all border border-white/10 hover:border-transparent">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- List -->
            <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-widest">История</div>
            <div id="listChats" class="flex-1 overflow-y-auto px-2 pb-2 space-y-1 custom-scrollbar">
                <!-- Chat Items -->
            </div>
        </div>

        <!-- MOBILE OVERLAY -->
        <div id="mobileOverlay" class="fixed inset-0 bg-black/50 z-10 md:hidden hidden backdrop-blur-sm transition-opacity"></div>

        <!-- CHAT AREA -->
        <div class="flex-1 h-full flex flex-col bg-[#0f0f0f] relative z-0 w-full">
            
            <!-- Header -->
            <div class="h-[70px] glass-header flex items-center justify-between px-4 md:px-6 z-20">
                <div class="flex items-center gap-4">
                    <button id="btnMobileMenu" class="md:hidden text-gray-400 hover:text-white"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg border border-white/10">
                            <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h3 id="chatTitle" class="text-[15px] font-semibold text-white">Новый чат</h3>
                            <p class="text-xs text-indigo-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-pulse"></span> Hybrid V2</p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/5 text-gray-400 hover:text-white transition-colors" onclick="clearContext()">
                        <i data-lucide="eraser" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar scroll-smooth">
                <!-- Welcome -->
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center opacity-100 transition-opacity duration-500">
                    <div class="text-center space-y-6 max-w-lg">
                        <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-500 pb-2">minimum ai</h1>
                        <p class="text-gray-400 text-lg">Что создадим сегодня?</p>
                        <div class="grid grid-cols-2 gap-3 text-left">
                            <button onclick="suggestionClick('Напиши код игры змейка на HTML')" class="p-4 rounded-2xl bg-[#1a1a1a] border border-[#2a2a2a] hover:border-indigo-500/50 hover:bg-[#202020] transition-all group">
                                <i data-lucide="code-2" class="w-6 h-6 mb-3 text-indigo-500 group-hover:scale-110 transition-transform"></i>
                                <div class="text-sm font-medium text-gray-200">Кодинг</div>
                                <div class="text-xs text-gray-500 mt-1">Создай игру или скрипт</div>
                            </button>
                            <button onclick="suggestionClick('Объясни квантовую физику простыми словами')" class="p-4 rounded-2xl bg-[#1a1a1a] border border-[#2a2a2a] hover:border-pink-500/50 hover:bg-[#202020] transition-all group">
                                <i data-lucide="book-open" class="w-6 h-6 mb-3 text-pink-500 group-hover:scale-110 transition-transform"></i>
                                <div class="text-sm font-medium text-gray-200">Анализ</div>
                                <div class="text-xs text-gray-500 mt-1">Сложное простыми словами</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="p-4 md:p-6 pb-6 md:pb-8">
                <!-- Attachments Preview -->
                <div id="attachmentPreview" class="flex gap-2 overflow-x-auto pb-2 px-2 hidden"></div>
                
                <div class="relative max-w-4xl mx-auto w-full group">
                    <!-- Glow effect -->
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-[24px] opacity-20 group-focus-within:opacity-50 transition duration-500 blur"></div>
                    
                    <div class="relative bg-[#1a1a1a] border border-[#2a2a2a] rounded-[22px] p-2 flex items-end gap-2 shadow-2xl">
                        <!-- File Upload -->
                        <input type="file" id="fileInput" multiple accept="image/*,.txt,.js,.py,.html,.css,.json,.md" class="hidden">
                        <button id="btnAttach" class="p-3 text-gray-500 hover:text-white transition-colors rounded-xl hover:bg-white/5">
                            <i data-lucide="paperclip" class="w-5 h-5"></i>
                        </button>
                        
                        <textarea id="inputMsg" rows="1" placeholder="Спроси о чем угодно..." class="w-full bg-transparent border-none outline-none text-white py-3 px-2 resize-none max-h-48 text-[16px] placeholder-gray-500 custom-scrollbar leading-relaxed font-sans"></textarea>
                        
                        <button id="btnSend" class="p-3 bg-white text-black rounded-[14px] hover:bg-gray-200 active:scale-95 transition-all shadow-lg shrink-0 disabled:opacity-50 disabled:scale-100 mb-0.5">
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                        </button>
                        <button id="btnStop" class="p-3 bg-red-500 text-white rounded-[14px] hover:bg-red-600 active:scale-95 transition-all shadow-lg shrink-0 hidden mb-0.5 animate-pulse">
                            <i data-lucide="square" class="w-4 h-4 fill-current"></i>
                        </button>
                    </div>
                </div>
                <div class="text-center mt-2">
                     <span class="text-[10px] text-gray-600">DarkGPT Hybrid V2 • OpenRouter • Powered by Minimum</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="modalSettings" class="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300">
        <div class="w-full max-w-md bg-[#181818] border border-[#2a2a2a] rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-all mx-4 relative">
            <div class="h-24 bg-gradient-to-r from-gray-800 to-[#1a1a1a] relative">
                <button id="btnCloseSettings" class="absolute top-4 right-4 p-2 bg-black/20 rounded-full hover:bg-black/40 text-white transition-colors backdrop-blur-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="px-6 relative -mt-12 flex flex-col items-center">
                <div class="relative group cursor-pointer w-24 h-24">
                    <img id="settingsAvatar" class="w-24 h-24 rounded-full bg-[#181818] object-cover border-4 border-[#181818] shadow-lg">
                    <div class="absolute inset-0 bg-black/50 rounded-full border-4 border-[#181818] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all backdrop-blur-[2px]">
                        <i data-lucide="camera" class="w-8 h-8 text-white"></i>
                    </div>
                    <input type="file" id="fileAvatar" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                <h2 class="mt-3 text-xl font-semibold text-white" id="settingsNameDisplay">Name</h2>
                <p class="text-gray-500 text-sm font-mono mb-6" id="settingsUsernameDisplay">@username</p>
            </div>
            <div class="px-6 pb-8 space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-semibold tracking-wider ml-1">Отображаемое имя</label>
                    <input id="editDisplayName" type="text" class="w-full bg-[#222] border border-[#333] rounded-xl p-3 mt-1 text-sm text-white focus:border-white/20 outline-none transition-all">
                </div>
                <div class="pt-4 flex gap-3">
                    <button id="btnLogout" class="flex-1 py-3 rounded-xl bg-[#2a2a2a] text-red-400 font-medium hover:bg-red-500/10 hover:text-red-400 transition-colors text-sm">Выйти</button>
                    <button id="btnSaveSettings" class="flex-[2] py-3 rounded-xl bg-white text-black font-semibold hover:bg-gray-200 transition-colors text-sm">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // Используем конфигурацию Firebase из min.html
        const firebaseConfig = {
          apiKey: "AIzaSyDuP_aYZpqJ-Y8LINCIywCFw3G2ZYVExv4",
          authDomain: "msgr-minimum.firebaseapp.com",
          projectId: "msgr-minimum",
          storageBucket: "msgr-minimum.firebasestorage.app",
          messagingSenderId: "583321384135",
          appId: "1:583321384135:web:2b9f7cae0f37419341fae2",
          measurementId: "G-2FFQC74VG6"
        };
        
        // Ключ от OpenRouter из aitest.html
        const AI_API_KEY = "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";
        const MODELS = {
            CHAT: "cognitivecomputations/dolphin-mistral-24b-venice-edition:free",
            VISION: "allenai/molmo-2-8b:free",
            CODE: "qwen/qwen3-coder:free"
        };
        const SYSTEM_PROMPT = "You are Minimum AI, a precise, uncensored, and helpful assistant. Use Markdown. Be concise unless asked for details.";

        let app, auth, db;
        let currentUser = null;
        let currentChatId = null;
        let currentAttachments = [];
        let isGenerating = false;
        let abortController = null;
        let chatsUnsubscribe = null;

        // --- MARKED CONFIG ---
        const renderer = new marked.Renderer();
        const originalHtml = renderer.html;
        renderer.html = (text) => text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); // Prevent XSS but keep basic format
        marked.use({ renderer });

        // --- INIT ---
        const init = () => {
            initCanvas();
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists && doc.data().username) {
                        switchView('viewApp');
                        initAppLogic(doc.data());
                    } else {
                        switchView('viewSetup');
                        document.getElementById('viewAuth').classList.add('hidden');
                    }
                } else {
                    currentUser = null;
                    switchView('viewAuth');
                }
            });

            setupEventListeners();
        };

        const switchView = (viewId) => {
            ['viewAuth', 'viewSetup', 'viewApp'].forEach(id => {
                const el = document.getElementById(id);
                if (id === viewId) {
                    el.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                    if (id === 'viewApp') el.classList.add('opacity-100');
                } else {
                    el.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => el.classList.add('hidden'), 500);
                }
            });
            lucide.createIcons();
        };

        // --- AUTH & PROFILE ---
        const setupEventListeners = () => {
            document.getElementById('btnGoogle').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
            
            const inputUsername = document.getElementById('inputUsername');
            inputUsername.addEventListener('input', (e) => {
                e.target.value = e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '').substring(0, 12);
                document.getElementById('setupError').style.opacity = '0';
            });

            document.getElementById('btnFinishSetup').onclick = async () => {
                const username = inputUsername.value;
                if (username.length < 3) return showSetupError("Минимум 3 символа");
                
                const btn = document.getElementById('btnFinishSetup');
                btn.innerText = "...";
                
                const check = await db.collection('users').where('username', '==', username).get();
                if (!check.empty) {
                    btn.innerText = "Начать";
                    return showSetupError("Занят");
                }
                
                await db.collection('users').doc(currentUser.uid).set({
                    uid: currentUser.uid, displayName: currentUser.displayName,
                    email: currentUser.email, photoURL: currentUser.photoURL,
                    username: username, bio: "Minimum User", createdAt: Date.now()
                }, { merge: true });
                location.reload();
            };

            // Sidebar & Settings
            document.getElementById('btnOpenSettings').onclick = openSettings;
            document.getElementById('btnCloseSettings').onclick = closeSettings;
            document.getElementById('btnSaveSettings').onclick = saveSettings;
            document.getElementById('fileAvatar').onchange = handleAvatarUpload;
            document.getElementById('btnLogout').onclick = () => auth.signOut().then(() => location.reload());
            
            // Chat
            document.getElementById('btnNewChat').onclick = createNewChat;
            document.getElementById('btnSend').onclick = handleSubmit;
            document.getElementById('btnStop').onclick = stopGeneration;
            document.getElementById('inputMsg').addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmit(); }
            });
            document.getElementById('inputMsg').addEventListener('input', function() {
                this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
            
            // Attachments
            document.getElementById('btnAttach').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('fileInput').onchange = handleFileSelect;

            // Mobile Menu
            const sidebar = document.getElementById('appSidebar');
            const overlay = document.getElementById('mobileOverlay');
            const toggleMenu = () => {
                const isOpen = !sidebar.classList.contains('-translate-x-full');
                if (isOpen) {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                } else {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                }
            };
            document.getElementById('btnMobileMenu').onclick = toggleMenu;
            overlay.onclick = toggleMenu;
        };

        const showSetupError = (msg) => {
            const el = document.getElementById('setupError');
            el.innerText = msg; el.style.opacity = '1';
        };

        // --- APP LOGIC ---
        const initAppLogic = (user) => {
            document.getElementById('myAvatar').src = user.photoURL;
            document.getElementById('myDisplayName').innerText = user.displayName;
            document.getElementById('myUsernameDisplay').innerText = "@" + user.username;
            loadChatList();
        };

        const loadChatList = () => {
            if (chatsUnsubscribe) chatsUnsubscribe();
            chatsUnsubscribe = db.collection('users').doc(currentUser.uid).collection('ai_chats')
                .orderBy('updatedAt', 'desc')
                .onSnapshot(snap => {
                    const list = document.getElementById('listChats');
                    list.innerHTML = '';
                    snap.forEach(doc => {
                        const chat = doc.data();
                        const id = doc.id;
                        const el = document.createElement('div');
                        el.className = `p-3 rounded-xl cursor-pointer flex gap-3 items-center transition-all group ${id === currentChatId ? 'bg-white/10' : 'hover:bg-white/5'}`;
                        el.onclick = () => loadChat(id);
                        el.innerHTML = `
                            <div class="w-10 h-10 rounded-lg bg-[#222] border border-white/5 flex items-center justify-center text-gray-400 group-hover:text-white transition-colors">
                                <i data-lucide="message-square" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-200 truncate">${chat.title || 'Новый чат'}</div>
                                <div class="text-xs text-gray-500 truncate">${new Date(chat.updatedAt).toLocaleDateString()}</div>
                            </div>
                            <button onclick="deleteChat('${id}', event)" class="opacity-0 group-hover:opacity-100 p-2 text-gray-500 hover:text-red-400 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        `;
                        list.appendChild(el);
                    });
                    lucide.createIcons();
                });
        };

        const createNewChat = async () => {
            const ref = await db.collection('users').doc(currentUser.uid).collection('ai_chats').add({
                title: 'Новый чат',
                createdAt: Date.now(),
                updatedAt: Date.now()
            });
            loadChat(ref.id);
            // Close mobile menu if open
            document.getElementById('appSidebar').classList.add('-translate-x-full');
            document.getElementById('mobileOverlay').classList.add('hidden');
        };

        const loadChat = async (id) => {
            currentChatId = id;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatMessages').innerHTML = '';
            
            const chatDoc = await db.collection('users').doc(currentUser.uid).collection('ai_chats').doc(id).get();
            document.getElementById('chatTitle').innerText = chatDoc.data()?.title || "Чат";

            const msgsSnap = await db.collection('users').doc(currentUser.uid).collection('ai_chats').doc(id).collection('messages').orderBy('timestamp', 'asc').get();
            
            msgsSnap.forEach(doc => {
                const data = doc.data();
                appendMessageToUI(data.role, data.content, false);
            });
            
            if(msgsSnap.empty) document.getElementById('welcomeScreen').style.display = 'flex';
            
            // Highlight active in list
            document.querySelectorAll('#listChats > div').forEach(el => el.classList.remove('bg-white/10'));
            // Refetch list to update styles is expensive but simple, instead rely on click handler logic or global redraw
        };

        window.deleteChat = async (id, e) => {
            e.stopPropagation();
            if(!confirm("Удалить чат?")) return;
            await db.collection('users').doc(currentUser.uid).collection('ai_chats').doc(id).delete();
            if(currentChatId === id) {
                currentChatId = null;
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('welcomeScreen').style.display = 'flex';
                document.getElementById('chatTitle').innerText = "Новый чат";
            }
        };

        window.suggestionClick = (text) => {
            document.getElementById('inputMsg').value = text;
            handleSubmit();
        };

        // --- MESSAGING & AI ---
        const handleSubmit = async () => {
            if (isGenerating || !currentChatId && !document.getElementById('inputMsg').value.trim() && currentAttachments.length === 0) {
                if (!currentChatId) createNewChat().then(handleSubmit);
                return;
            }
            if (isGenerating) return;

            if (!currentChatId) {
                await createNewChat();
            }

            const input = document.getElementById('inputMsg');
            let text = input.value.trim();
            
            // Format Content
            let messageContent = [];
            let hasImages = false;

            // Handle Text Files
            const textFiles = currentAttachments.filter(a => a.type === 'text_file');
            if (textFiles.length > 0) {
                text += "\n\n--- FILES ---\n";
                textFiles.forEach(f => { text += `\n[File: ${f.name}]\n${f.content}\n`; });
            }
            if (text) messageContent.push({ type: "text", text: text });

            // Handle Images
            const images = currentAttachments.filter(a => a.type === 'image_url');
            if (images.length > 0) {
                hasImages = true;
                images.forEach(img => messageContent.push({ type: "image_url", image_url: { url: img.content } }));
            }

            if (messageContent.length === 0) return;

            // UI Reset
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('attachmentPreview').innerHTML = '';
            document.getElementById('attachmentPreview').classList.add('hidden');
            const tempAttachments = [...currentAttachments];
            currentAttachments = [];

            // 1. Show User Message
            appendMessageToUI('user', messageContent, true);
            
            // 2. Save User Message
            const userMsgData = { role: 'user', content: messageContent, timestamp: Date.now() };
            await db.collection('users').doc(currentUser.uid).collection('ai_chats').doc(currentChatId).collection('messages').add(userMsgData);

            // 3. AI Generation
            generateResponse(hasImages);
        };

        const generateResponse = async (isVision) => {
            isGenerating = true;
            abortController = new AbortController();
            updateControls();

            // Create placeholder for bot
            const botMsgId = 'msg_' + Date.now();
            appendMessageToUI('assistant', '', true, botMsgId);
            const botBubble = document.getElementById(botMsgId).querySelector('.prose');

            // Get Context
            const historySnap = await db.collection('users').doc(currentUser.uid).collection('ai_chats').doc(currentChatId).collection('messages').orderBy('timestamp', 'asc').get();
            let messages = [];
            
            historySnap.forEach(doc => {
                const d = doc.data();
                // Adapter for API
                if (d.role === 'user' && Array.isArray(d.content)) {
                    if (isVision) {
                        messages.push({ role: d.role, content: d.content });
                    } else {
                        // Extract text only for text models
                        const txt = d.content.find(c => c.type === 'text')?.text || "";
                        messages.push({ role: d.role, content: txt + (d.content.length > 1 ? " [Image Attachment]" : "") });
                    }
                } else {
                    messages.push({ role: d.role, content: d.content });
                }
            });

            // Model Selection logic from aitest.html
            let model = MODELS.CHAT;
            if (isVision) model = MODELS.VISION;
            else {
                const lastUserTxt = messages[messages.length - 1].content;
                const txtToCheck = typeof lastUserTxt === 'string' ? lastUserTxt : (lastUserTxt.find(c=>c.type==='text')?.text || "");
                if (/html|css|js|python|code|script|api/i.test(txtToCheck)) model = MODELS.CODE;
            }

            try {
                // Streaming Request
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${AI_API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            ...messages
                        ],
                        stream: true
                    }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const data = JSON.parse(line.slice(6));
                                const content = data.choices[0]?.delta?.content || "";
                                fullText += content;
                                botBubble.innerHTML = marked.parse(fullText);
                                hljs.highlightAll();
                                scrollToBottom();
                            } catch (e) {}
                        }
                    }
                }

                // Save Bot Message
                await db.collection('users').doc(currentUser.uid).collection('ai_chats').doc(currentChatId).collection('messages').add({
                    role: 'assistant', content: fullText, timestamp: Date.now()
                });
                
                // Update Title if new
                if (messages.length <= 2) {
                    generateTitle(messages[0].content);
                }

            } catch (e) {
                if (e.name !== 'AbortError') {
                    botBubble.innerHTML += `<br><span class="text-red-400 text-xs">Error: ${e.message}</span>`;
                }
            } finally {
                isGenerating = false;
                abortController = null;
                updateControls();
                // Update timestamp for sorting
                db.collection('users').doc(currentUser.uid).collection('ai_chats').doc(currentChatId).update({ updatedAt: Date.now() });
            }
        };

        async function generateTitle(content) {
            let txt = Array.isArray(content) ? content.find(c=>c.type==='text')?.text : content;
            if(!txt) return;
            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${AI_API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: MODELS.CHAT, messages: [{ role: "user", content: `Summarize in 2-3 words for title: ${txt}` }] })
                });
                const data = await res.json();
                const title = data.choices[0].message.content.replace(/["\.]/g, '');
                db.collection('users').doc(currentUser.uid).collection('ai_chats').doc(currentChatId).update({ title: title });
            } catch(e){}
        }

        const stopGeneration = () => { if(abortController) abortController.abort(); };

        const appendMessageToUI = (role, content, animate = false, id = null) => {
            const container = document.getElementById('chatMessages');
            const isUser = role === 'user';
            
            const div = document.createElement('div');
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} ${animate ? 'animate-slide-up' : ''}`;
            if(id) div.id = id;

            let htmlContent = '';
            
            if (isUser) {
                if (Array.isArray(content)) {
                    // Render Images
                    const imgs = content.filter(c => c.type === 'image_url');
                    if (imgs.length) htmlContent += `<div class="flex gap-2 mb-2 justify-end flex-wrap">${imgs.map(i => `<img src="${i.image_url.url}" class="h-32 rounded-lg border border-white/10">`).join('')}</div>`;
                    
                    const txt = content.find(c => c.type === 'text');
                    if (txt) htmlContent += `<div class="whitespace-pre-wrap">${txt.text}</div>`;
                } else {
                    htmlContent = `<div class="whitespace-pre-wrap">${content}</div>`;
                }
            } else {
                htmlContent = marked.parse(typeof content === 'string' ? content : "...");
            }

            const bubbleClass = isUser 
                ? 'bg-white text-black rounded-[20px_20px_4px_20px]' 
                : 'bg-[#232323] text-gray-200 rounded-[20px_20px_20px_4px] prose prose-invert max-w-none w-full md:w-[85%]';

            div.innerHTML = `
                <div class="${bubbleClass} px-5 py-3 shadow-md text-[15px] leading-relaxed break-words relative border border-white/5">
                    ${htmlContent}
                </div>
            `;
            
            container.appendChild(div);
            if (!isUser && !id) hljs.highlightAll(); // Highlight saved messages
            scrollToBottom();
        };

        const updateControls = () => {
            const btnSend = document.getElementById('btnSend');
            const btnStop = document.getElementById('btnStop');
            if (isGenerating) {
                btnSend.classList.add('hidden');
                btnStop.classList.remove('hidden');
            } else {
                btnSend.classList.remove('hidden');
                btnStop.classList.add('hidden');
            }
        };

        const scrollToBottom = () => {
            const el = document.getElementById('chatMessages');
            el.scrollTop = el.scrollHeight;
        };

        // --- FILE HANDLING ---
        const handleFileSelect = async (e) => {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('attachmentPreview');
            preview.classList.remove('hidden');
            
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const b64 = await compressImage(file);
                    currentAttachments.push({ type: 'image_url', content: b64, name: file.name });
                    addPreviewItem(b64, true, currentAttachments.length - 1);
                } else {
                    const text = await readFileAsText(file);
                    currentAttachments.push({ type: 'text_file', content: text, name: file.name });
                    addPreviewItem(null, false, currentAttachments.length - 1, file.name.split('.').pop());
                }
            }
            document.getElementById('fileInput').value = '';
        };

        const addPreviewItem = (src, isImg, index, ext) => {
            const el = document.createElement('div');
            el.className = 'preview-item';
            el.innerHTML = `
                ${isImg ? `<img src="${src}">` : `<div class="w-full h-full flex items-center justify-center text-xs font-mono text-gray-400 bg-[#2a2a2a] uppercase">${ext}</div>`}
                <button class="preview-remove" onclick="removeAttachment(${index})"><i data-lucide="x" class="w-3 h-3"></i></button>
            `;
            document.getElementById('attachmentPreview').appendChild(el);
        };

        window.removeAttachment = (idx) => {
            currentAttachments.splice(idx, 1);
            document.getElementById('attachmentPreview').innerHTML = '';
            currentAttachments.forEach((a, i) => {
                if(a.type === 'image_url') addPreviewItem(a.content, true, i);
                else addPreviewItem(null, false, i, a.name.split('.').pop());
            });
            if (currentAttachments.length === 0) document.getElementById('attachmentPreview').classList.add('hidden');
        };

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX = 1024;
                        let w = img.width, h = img.height;
                        if(w>h) { if(w>MAX) { h*=MAX/w; w=MAX; } } else { if(h>MAX) { w*=MAX/h; h=MAX; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img,0,0,w,h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }
        function readFileAsText(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsText(file);
            });
        }

        // --- BACKGROUND ---
        const initCanvas = () => {
            const c = document.getElementById('bgCanvas');
            const ctx = c.getContext('2d');
            let w, h;
            const resize = () => { w = c.width = innerWidth; h = c.height = innerHeight; };
            window.onresize = resize; resize();
            const particles = Array.from({length: 30}, () => ({
                x: Math.random()*w, y: Math.random()*h, vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3, s: Math.random()*2
            }));
            const animate = () => {
                ctx.clearRect(0,0,w,h);
                ctx.fillStyle = "rgba(255,255,255,0.05)";
                particles.forEach(p => {
                    p.x+=p.vx; p.y+=p.vy;
                    if(p.x<0||p.x>w) p.vx*=-1; if(p.y<0||p.y>h) p.vy*=-1;
                    ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill();
                });
                requestAnimationFrame(animate);
            };
            animate();
        };

        // --- SETTINGS (Reuse from min.html logic) ---
        let newAvatarBase64 = null;
        function openSettings() {
            const m = document.getElementById('modalSettings');
            m.classList.remove('opacity-0', 'pointer-events-none');
            m.querySelector('div').classList.remove('scale-95');
            m.querySelector('div').classList.add('scale-100');
            document.getElementById('settingsAvatar').src = currentUser.photoURL;
            document.getElementById('settingsNameDisplay').innerText = currentUser.displayName;
            document.getElementById('editDisplayName').value = currentUser.displayName;
            document.getElementById('appSidebar').classList.add('-translate-x-full'); // Close menu on mobile
            document.getElementById('mobileOverlay').classList.add('hidden');
        }
        function closeSettings() {
            const m = document.getElementById('modalSettings');
            m.classList.add('opacity-0', 'pointer-events-none');
            m.querySelector('div').classList.remove('scale-100');
            m.querySelector('div').classList.add('scale-95');
        }
        async function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            newAvatarBase64 = await compressImage(file);
            document.getElementById('settingsAvatar').src = newAvatarBase64;
        }
        async function saveSettings() {
            const name = document.getElementById('editDisplayName').value;
            const updates = { displayName: name };
            if (newAvatarBase64) updates.photoURL = newAvatarBase64;
            await db.collection('users').doc(currentUser.uid).update(updates);
            closeSettings();
            location.reload();
        }

        init();
    </script>
</body>
</html>

