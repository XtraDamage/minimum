<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>minimum</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Inter (Modern, Clean) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Icons: Lucide (Minimalist) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        mono: {
                            50: '#f9f9f9',
                            100: '#ececec',
                            200: '#e3e3e3',
                            300: '#cdcdcd',
                            400: '#b4b4b4',
                            500: '#9b9b9b',
                            600: '#676767',
                            700: '#424242',
                            800: '#2f2f2f',
                            900: '#1a1a1a',
                            950: '#0d0d0d',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Reset & Custom Scrollbar */
        body {
            background-color: #000000;
            color: #ffffff;
            overflow: hidden; /* Prevent body scroll, use containers */
            -webkit-tap-highlight-color: transparent;
        }

        /* Minimalist Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-light {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Floating Animation Class */
        .floating {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Loader */
        .loader {
            border-top-color: #fff;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message Bubbles */
        .msg-own {
            background: #ffffff;
            color: #000000;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }
        .msg-other {
            background: #1a1a1a;
            color: #ffffff;
            border: 1px solid #333;
            border-radius: 18px 18px 18px 4px;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative font-sans">

    <!-- CANVAS BACKGROUND (Antigravity) -->
    <canvas id="bgCanvas" class="absolute top-0 left-0 w-full h-full z-0 pointer-events-none opacity-40"></canvas>

    <!-- APP CONTAINER -->
    <div id="app" class="relative z-10 w-full h-full max-w-[1400px] flex overflow-hidden transition-all duration-500">
        
        <!-- LOGIN SCREEN -->
        <div id="loginScreen" class="absolute inset-0 z-50 flex items-center justify-center bg-black">
            <div class="glass p-8 md:p-12 rounded-3xl flex flex-col items-center gap-8 max-w-md w-[90%] border border-white/10 shadow-2xl shadow-white/5 animate-slide-up">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-2 shadow-[0_0_30px_rgba(255,255,255,0.3)]">
                    <i data-lucide="infinity" class="w-8 h-8 text-black"></i>
                </div>
                <div class="text-center">
                    <h1 class="text-4xl font-light tracking-tighter text-white mb-2">minimum</h1>
                    <p class="text-mono-500 text-sm tracking-widest uppercase">Pure connection</p>
                </div>
                
                <button id="googleLoginBtn" class="group relative overflow-hidden rounded-full bg-white text-black px-8 py-4 font-medium transition-all hover:scale-105 active:scale-95 w-full flex items-center justify-center gap-3">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors"></div>
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" />
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                    </svg>
                    <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                </button>
                <div id="loginError" class="text-red-400 text-xs hidden text-center mt-2"></div>
            </div>
        </div>

        <!-- MAIN INTERFACE (Hidden by default) -->
        <div id="mainInterface" class="w-full h-full flex opacity-0 pointer-events-none transition-opacity duration-700">
            
            <!-- SIDEBAR (Chat List) -->
            <div class="hidden md:flex w-80 h-full glass border-r border-white/10 flex-col z-20">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h2 class="text-xl font-medium tracking-tight">Chats</h2>
                    <button id="logoutBtn" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="–í—ã–π—Ç–∏">
                        <i data-lucide="log-out" class="w-5 h-5 text-mono-400"></i>
                    </button>
                </div>
                
                <!-- Search (Visual) -->
                <div class="px-4 py-4">
                    <div class="bg-mono-900 rounded-xl flex items-center px-4 py-2.5 border border-white/5 focus-within:border-white/30 transition-colors">
                        <i data-lucide="search" class="w-4 h-4 text-mono-500 mr-3"></i>
                        <input type="text" placeholder="–ü–æ–∏—Å–∫" class="bg-transparent border-none outline-none text-sm text-white w-full placeholder-mono-600">
                    </div>
                </div>

                <!-- Chat List Items -->
                <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chatList">
                    <!-- Active Chat (Global) -->
                    <div class="p-3 rounded-xl bg-white/10 border border-white/5 cursor-pointer flex gap-3 items-center group">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-gray-700 to-black border border-white/20 flex items-center justify-center text-lg relative overflow-hidden">
                            <span class="z-10">üåç</span>
                            <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-baseline mb-0.5">
                                <h3 class="font-medium text-white text-sm truncate">–û–±—â–∏–π —ç—Ñ–∏—Ä</h3>
                                <span class="text-xs text-mono-500">–°–µ–π—á–∞—Å</span>
                            </div>
                            <p class="text-xs text-mono-400 truncate">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è...</p>
                        </div>
                    </div>
                    
                    <!-- Mock Chats (For Design) -->
                    <div class="p-3 rounded-xl hover:bg-white/5 cursor-pointer flex gap-3 items-center transition-colors opacity-50">
                        <div class="w-12 h-12 rounded-full bg-mono-800 flex items-center justify-center text-sm border border-white/5">AI</div>
                        <div class="flex-1">
                            <div class="flex justify-between items-baseline mb-0.5">
                                <h3 class="font-medium text-mono-300 text-sm">System</h3>
                                <span class="text-xs text-mono-600">12:00</span>
                            </div>
                            <p class="text-xs text-mono-600 truncate">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ minimum.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHAT AREA -->
            <div class="flex-1 h-full flex flex-col relative bg-black/50">
                <!-- Mobile Header -->
                <div class="md:hidden glass p-4 flex justify-between items-center z-30 border-b border-white/10">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-black font-bold text-xs">M</div>
                        <span class="font-medium text-sm">–û–±—â–∏–π —ç—Ñ–∏—Ä</span>
                    </div>
                    <button id="mobileLogoutBtn" class="text-mono-400">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Messages Container -->
                <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
                    <!-- Loading State -->
                    <div id="messagesLoader" class="flex justify-center items-center h-full">
                        <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-6 w-6"></div>
                    </div>
                    <!-- Messages will be injected here -->
                </div>

                <!-- Input Area -->
                <div class="p-4 md:p-6 z-30">
                    <div class="glass-light rounded-3xl p-1.5 flex items-end gap-2 shadow-2xl relative transition-all duration-300 focus-within:ring-1 focus-within:ring-white/20 focus-within:bg-black/80">
                        <button class="p-3 text-mono-400 hover:text-white transition-colors rounded-full hover:bg-white/10 shrink-0">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                        <textarea id="messageInput" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="w-full bg-transparent border-none outline-none text-white py-3 px-2 resize-none max-h-32 text-sm md:text-base font-light placeholder-mono-600 custom-scrollbar"></textarea>
                        <button id="sendBtn" class="p-3 bg-white text-black rounded-full hover:scale-105 active:scale-95 transition-all shadow-lg shrink-0 opacity-50 cursor-not-allowed" disabled>
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & SETUP ---
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫
        lucide.createIcons();

        // UPDATED: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –ø—Ä–æ–µ–∫—Ç–∞ "minimum"
        const firebaseConfig = {
          apiKey: "AIzaSyDuP_aYZpqJ-Y8LINCIywCFw3G2ZYVExv4",
          authDomain: "msgr-minimum.firebaseapp.com",
          projectId: "msgr-minimum",
          storageBucket: "msgr-minimum.firebasestorage.app",
          messagingSenderId: "583321384135",
          appId: "1:583321384135:web:2b9f7cae0f37419341fae2",
          measurementId: "G-2FFQC74VG6"
        };

        let app, auth, db, user;
        
        // --- FIREBASE LOGIC ---
        const initFirebase = () => {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç–≤–æ–∏–º –∫–æ–Ω—Ñ–∏–≥–æ–º
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                
                auth = firebase.auth();
                db = firebase.firestore();
                
                // –í–∫–ª—é—á–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ (–∫—ç—à)
                db.enablePersistence().catch(err => {
                    if (err.code == 'failed-precondition') {
                         console.log("Persistence failed: Multiple tabs open");
                    } else if (err.code == 'unimplemented') {
                         console.log("Persistence not supported by browser");
                    }
                });

                console.log("Firebase Initialized: msgr-minimum");
                return true;
            } catch (e) {
                console.error("Firebase Config Error:", e);
                document.getElementById('loginError').innerText = "Critical Error: " + e.message;
                document.getElementById('loginError').classList.remove('hidden');
                return false;
            }
        };

        // --- 2. CANVAS ANIMATION (ANTIGRAVITY) ---
        const initCanvas = () => {
            const canvas = document.getElementById('bgCanvas');
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];

            const resize = () => {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            };

            class Particle {
                constructor() {
                    this.x = Math.random() * width;
                    this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 0.5; // Slow movement
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.size = Math.random() * 2 + 1;
                    this.alpha = Math.random() * 0.5 + 0.1;
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;

                    // Wrap around screen
                    if (this.x < 0) this.x = width;
                    if (this.x > width) this.x = 0;
                    if (this.y < 0) this.y = height;
                    if (this.y > height) this.y = 0;
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                    ctx.fill();
                }
            }

            const initParticles = () => {
                particles = [];
                const count = Math.min((width * height) / 15000, 100); // Responsive count
                for (let i = 0; i < count; i++) {
                    particles.push(new Particle());
                }
            };

            const animate = () => {
                ctx.clearRect(0, 0, width, height);
                
                // Draw connections
                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i];
                    p.update();
                    p.draw();

                    for (let j = i + 1; j < particles.length; j++) {
                        const p2 = particles[j];
                        const dx = p.x - p2.x;
                        const dy = p.y - p2.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < 150) {
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(255, 255, 255, ${(150 - distance) / 150 * 0.15})`;
                            ctx.lineWidth = 0.5;
                            ctx.moveTo(p.x, p.y);
                            ctx.lineTo(p2.x, p2.y);
                            ctx.stroke();
                        }
                    }
                }
                requestAnimationFrame(animate);
            };

            window.addEventListener('resize', () => {
                resize();
                initParticles();
            });
            
            resize();
            initParticles();
            animate();
        };

        // --- 3. UI LOGIC & STATE ---
        const ui = {
            loginScreen: document.getElementById('loginScreen'),
            mainInterface: document.getElementById('mainInterface'),
            msgContainer: document.getElementById('messagesContainer'),
            msgInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            loginBtn: document.getElementById('googleLoginBtn'),
            loader: document.getElementById('messagesLoader')
        };

        // Helper to format time
        const formatTime = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        // Render Message
        const renderMessage = (msg, isOwn) => {
            const div = document.createElement('div');
            div.className = `flex w-full mb-4 opacity-0 animate-slide-up ${isOwn ? 'justify-end' : 'justify-start'}`;
            
            // Avatar for others
            const avatarHtml = !isOwn ? 
                `<div class="w-8 h-8 rounded-full bg-mono-800 border border-white/10 flex items-center justify-center text-xs text-white mr-2 shrink-0 overflow-hidden">
                    ${msg.photoURL ? `<img src="${msg.photoURL}" class="w-full h-full object-cover">` : (msg.displayName?.[0] || '?')}
                 </div>` : '';

            // Bubble
            const bubbleClass = isOwn ? 'msg-own' : 'msg-other';
            const statusIcon = isOwn ? '<i data-lucide="check-check" class="w-3 h-3 ml-1 opacity-70"></i>' : '';

            div.innerHTML = `
                ${avatarHtml}
                <div class="${bubbleClass} max-w-[75%] md:max-w-[60%] px-4 py-2.5 relative group">
                    ${!isOwn ? `<p class="text-[10px] text-mono-400 mb-0.5">${msg.displayName || 'Anon'}</p>` : ''}
                    <p class="text-sm md:text-base leading-relaxed break-words whitespace-pre-wrap">${escapeHtml(msg.text)}</p>
                    <div class="flex items-center justify-end mt-1 gap-1">
                        <span class="text-[10px] ${isOwn ? 'text-black/50' : 'text-white/30'}">${formatTime(msg.timestamp)}</span>
                        ${isOwn ? statusIcon : ''}
                    </div>
                </div>
            `;
            
            ui.msgContainer.appendChild(div);
            lucide.createIcons(); // Refresh icons in new message
            scrollToBottom();
        };

        // Auto-scroll logic
        const scrollToBottom = () => {
            ui.msgContainer.scrollTo({
                top: ui.msgContainer.scrollHeight,
                behavior: 'smooth'
            });
        };

        // Escape HTML to prevent XSS
        const escapeHtml = (unsafe) => {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // --- 4. APP LOGIC ---

        const runApp = () => {
            if (!initFirebase()) return;
            initCanvas();

            // Auth Listener
            auth.onAuthStateChanged((currentUser) => {
                user = currentUser;
                if (user) {
                    // Logged In
                    ui.loginScreen.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => ui.loginScreen.style.display = 'none', 500);
                    
                    ui.mainInterface.classList.remove('opacity-0', 'pointer-events-none');
                    ui.mainInterface.classList.add('opacity-100');
                    
                    loadMessages();
                } else {
                    // Logged Out
                    ui.loginScreen.style.display = 'flex';
                    ui.loginScreen.classList.remove('opacity-0', 'pointer-events-none');
                    ui.mainInterface.classList.add('opacity-0', 'pointer-events-none');
                    ui.mainInterface.classList.remove('opacity-100');
                    ui.msgContainer.innerHTML = ''; 
                    ui.msgContainer.appendChild(ui.loader);
                }
            });

            // Login Action
            ui.loginBtn.addEventListener('click', async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error("Login Failed", error);
                    const errDiv = document.getElementById('loginError');
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
                    let msg = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message;
                    if (error.code === 'auth/popup-closed-by-user') msg = "–í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º";
                    if (error.code === 'auth/cancelled-popup-request') msg = "–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω";
                    
                    errDiv.innerText = msg;
                    errDiv.classList.remove('hidden');
                }
            });

            // Logout Actions
            const logout = () => auth.signOut();
            document.getElementById('logoutBtn')?.addEventListener('click', logout);
            document.getElementById('mobileLogoutBtn')?.addEventListener('click', logout);

            // Message Loading (Realtime)
            let unsubscribe;
            const loadMessages = () => {
                if (unsubscribe) unsubscribe();
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é 'messages' –≤ –∫–æ—Ä–Ω–µ –∏–ª–∏ –ø–æ–¥ 'chats/general'
                // –î–ª—è —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å—Ç—ã–π –ø—É—Ç—å:
                const messagesRef = db.collection('chats').doc('general').collection('messages');

                unsubscribe = messagesRef.onSnapshot((snapshot) => {
                    ui.loader.remove();
                    
                    const rawData = [];
                    snapshot.forEach(doc => rawData.push({ id: doc.id, ...doc.data() }));
                    
                    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (—Å–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤)
                    rawData.sort((a, b) => a.timestamp - b.timestamp);

                    ui.msgContainer.innerHTML = '';
                    
                    if (rawData.length === 0) {
                        ui.msgContainer.innerHTML = `
                            <div class="h-full flex flex-col items-center justify-center text-mono-600 opacity-50">
                                <i data-lucide="message-square" class="w-12 h-12 mb-2"></i>
                                <p>–ß–∞—Ç –ø—É—Å—Ç. –ù–∞–ø–∏—à–∏ –ø–µ—Ä–≤—ã–º.</p>
                            </div>
                        `;
                        lucide.createIcons();
                    } else {
                        rawData.forEach(msg => renderMessage(msg, msg.uid === user.uid));
                    }
                }, (error) => {
                    console.error("Firestore Error:", error);
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
                    if (error.code === 'permission-denied') {
                         ui.msgContainer.innerHTML = `<div class="text-red-500 text-center mt-10">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É.<br>–ü—Ä–æ–≤–µ—Ä—å Security Rules –≤ Firebase Console.</div>`;
                    }
                });
            };

            // Send Message
            const sendMessage = async () => {
                const text = ui.msgInput.value.trim();
                if (!text || !user) return;

                ui.msgInput.value = '';
                ui.sendBtn.disabled = true;
                ui.sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
                ui.msgInput.style.height = 'auto';

                // –¢–æ—Ç –∂–µ –ø—É—Ç—å, —á—Ç–æ –∏ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏
                const messagesRef = db.collection('chats').doc('general').collection('messages');

                try {
                    await messagesRef.add({
                        text: text,
                        uid: user.uid,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        timestamp: Date.now()
                    });
                } catch (e) {
                    console.error("Send Error", e);
                    alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    ui.sendBtn.disabled = false;
                    ui.sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            };

            // Input Handling
            ui.sendBtn.addEventListener('click', sendMessage);
            ui.msgInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            ui.msgInput.addEventListener('input', function() {
                // Auto resize textarea
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                
                // Toggle button state
                if (this.value.trim().length > 0) {
                    ui.sendBtn.disabled = false;
                    ui.sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    ui.sendBtn.disabled = true;
                    ui.sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
        };

        // Start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runApp);
        } else {
            runApp();
        }

    </script>
</body>
</html>